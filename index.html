<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Ausbildungs-Cockpit | Hotel-KoFa EFZ</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged }
  from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, addDoc, deleteDoc, serverTimestamp }
  from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject }
  from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

const firebaseConfig = {
  apiKey:            "AIzaSyDiuNW9oZ-wSuGp5EZfLn_hBfK3W5iuHYo",
  authDomain:        "ausbildungs-cockpit.firebaseapp.com",
  projectId:         "ausbildungs-cockpit",
  storageBucket:     "ausbildungs-cockpit.firebasestorage.app",
  messagingSenderId: "286858503649",
  appId:             "1:286858503649:web:b6fd5c221cb36b75a2dea0"
};
const fbApp = initializeApp(firebaseConfig);
const auth  = getAuth(fbApp);
const db    = getFirestore(fbApp);
const stor  = getStorage(fbApp);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BILDUNGSPLAN â€” exakte LZ-Semester-Zuordnung gemÃ¤ss GesamtÃ¼bersicht
// Format: { lz_key: [sem, ...], ... }
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LZ_SEM = {
  // HK 1.1
  "1.1.1":[2,3],"1.1.2":[1],"1.1.3":[3],"1.1.4":[1],"1.1.5":[2,3,4],"1.1.6":[1],"1.1.7":[2,3,4],
  // HK 1.2
  "1.2.1":[1],"1.2.2":[3],"1.2.3":[5],"1.2.4":[1,2,3,5],"1.2.5":[5],"1.2.6":[5],"1.2.7":[4],
  // HK 1.3
  "1.3.1":[2],"1.3.2":[2],"1.3.3":[1],"1.3.4":[1],"1.3.5":[1],"1.3.6":[1],"1.3.7":[2,3],
  // HK 1.4
  "1.4.1":[2],"1.4.2":[2],"1.4.3":[2],"1.4.4":[3],"1.4.5":[3],"1.4.6":[4],
  "1.4.7":[2],"1.4.8":[4],"1.4.9":[1],"1.4.10":[3,5],"1.4.11":[2],"1.4.12":[3],"1.4.13":[5],
  // HK 1.5
  "1.5.1":[2],"1.5.2":[4],"1.5.3":[4],"1.5.4":[2],"1.5.5":[3],"1.5.6":[4],
  // HK 1.6
  "1.6.1":[1],"1.6.2":[1,3],"1.6.3":[4],"1.6.4":[2],"1.6.5":[3],"1.6.6":[3,5],
  // HK 1.7
  "1.7.1":[1],"1.7.2":[1,3],"1.7.3":[4],"1.7.4":[2],"1.7.5":[3],"1.7.6":[3,5],
  // HK 2.1
  "2.1.1":[3],"2.1.2":[3],"2.1.3":[3],"2.1.4":[3],"2.1.5":[3],
  // HK 2.2
  "2.2.1":[3],"2.2.2":[3],"2.2.3":[3],"2.2.4":[3],"2.2.5":[3],
  // HK 2.3
  "2.3.1":[5],
  // HK 3.1
  "3.1.1":[3],"3.1.2":[3],"3.1.3":[3],"3.1.4":[3],"3.1.5":[3],"3.1.6":[3],"3.1.7":[5],"3.1.8":[1],"3.1.9":[2],
  // HK 3.2
  "3.2.1":[2],"3.2.3":[2],"3.2.4":[2],"3.2.5":[3],"3.2.6":[3],"3.2.7":[2],"3.2.8":[1],
  // HK 3.3
  "3.3.1":[3],"3.3.2":[2],"3.3.3":[3],"3.3.4":[3],"3.3.5":[4],"3.3.6":[4],"3.3.7":[4],"3.3.8":[4],
  // HK 3.4
  "3.4.1":[5],"3.4.2":[5],"3.4.3":[5],"3.4.4":[5],"3.4.5":[5],
  // HK 3.5
  "3.5.1":[5],"3.5.3":[5],
  // HK 3.6
  "3.6.1":[5],"3.6.2":[5],
  // HK 3.7
  "3.7.1":[5],"3.7.2":[5],
  // HK 4.1
  "4.1.1":[1],"4.1.2":[1],"4.1.3":[1],
  // HK 4.2
  "4.2.1":[1],"4.2.2":[1],"4.2.3":[1],"4.2.4":[1],"4.2.5":[1],"4.2.7":[1],"4.2.8":[1],"4.2.9":[1],
  // HK 4.3
  "4.3.1":[1,2],"4.3.3":[1],"4.3.4":[3],"4.3.5":[5],"4.3.6":[1],"4.3.7":[1],"4.3.8":[2],"4.3.10":[2],"4.3.11":[5],
  // HK 4.4
  "4.4.1":[2],"4.4.2":[3],"4.4.3":[4]
};

// VollstÃ¤ndiger Bildungsplan mit exakten LZ-Codes
const BP = [
  { id:1, code:"HKB 1", color:"#C9A84C",
    titel:"Beraten und Betreuen von GÃ¤sten und Partnern",
    kompetenzen:[
      { id:"1.1", titel:"Kommunikation bedarfs- und zielorientiert gestalten", tax:"K4",
        lz:[
          {k:"1.1.1", t:"Kultureller und religiÃ¶ser Hintergrund"},
          {k:"1.1.2", t:"Grundlagen der Kommunikation (4 Ebenen)"},
          {k:"1.1.3", t:"Beratungs-, Verkaufs-, Feedback- und ReklamationsgesprÃ¤che"},
          {k:"1.1.4", t:"Auftreten und persÃ¶nliches Erscheinungsbild"},
          {k:"1.1.5", t:"Verbale und nonverbale Kommunikation"},
          {k:"1.1.6", t:"Mit GÃ¤sten, Vorgesetzten, Partnern und Mitarbeitenden kommunizieren"},
          {k:"1.1.7", t:"Empathischer Umgang"}
        ]},
      { id:"1.2", titel:"Arbeits- und Tagesplanung kontrollieren und sicherstellen", tax:"K4",
        lz:[
          {k:"1.2.1", t:"Betriebseigenes Organigramm beschreiben"},
          {k:"1.2.2", t:"Betriebseigenes Organigramm zeichnen"},
          {k:"1.2.3", t:"Anforderungsprofile fÃ¼r Stellen verfassen"},
          {k:"1.2.4", t:"Betriebliche Prozesse anwenden"},
          {k:"1.2.5", t:"Nahtstellen analysieren"},
          {k:"1.2.6", t:"Stellenbeschreibungen erstellen"},
          {k:"1.2.7", t:"Tagesplanung kontrollieren"}
        ]},
      { id:"1.3", titel:"Betriebliche Produkte und Dienstleistungen zuordnen", tax:"K3",
        lz:[
          {k:"1.3.1", t:"GetrÃ¤nkeangebot und GetrÃ¤nkeservice"},
          {k:"1.3.2", t:"Speise- und GetrÃ¤nkeangebot erklÃ¤ren"},
          {k:"1.3.3", t:"Maschinen und GerÃ¤te in der KÃ¼che bedienen"},
          {k:"1.3.4", t:"Speisen und Produkte herstellen"},
          {k:"1.3.5", t:"Betriebliche ErnÃ¤hrungsgrundsÃ¤tze anwenden"},
          {k:"1.3.6", t:"Nahrungsmittelallergien und -intoleranzen beraten"},
          {k:"1.3.7", t:"GÃ¤ste mit Allergien und Intoleranzen beraten (vertieft)"}
        ]},
      { id:"1.4", titel:"GÃ¤ste betreuen, Produkte und Dienstleistungen verkaufen", tax:"K4",
        lz:[
          {k:"1.4.1", t:"Mise en Place vorbereiten"},
          {k:"1.4.2", t:"Tische eindecken und Servicegrundregeln"},
          {k:"1.4.3", t:"Servicegrundregeln umsetzen"},
          {k:"1.4.4", t:"Check-in durchfÃ¼hren"},
          {k:"1.4.5", t:"Check-out durchfÃ¼hren"},
          {k:"1.4.6", t:"VerkaufsfÃ¶rdernde BeratungsgesprÃ¤che und Upselling"},
          {k:"1.4.7", t:"Betriebliche Dienstleistungen und Produkte beschreiben"},
          {k:"1.4.8", t:"Proaktive und vorausschauende GÃ¤stebetreuung"},
          {k:"1.4.9", t:"GÃ¤ste begleiten"},
          {k:"1.4.10", t:"BedÃ¼rfnisse der GÃ¤ste erfassen"},
          {k:"1.4.11", t:"Ambiente erklÃ¤ren"},
          {k:"1.4.12", t:"Ambiente gestalten"},
          {k:"1.4.13", t:"Ideen zur Gestaltung des Ambientes entwickeln"}
        ]},
      { id:"1.5", titel:"RÃ¼ckmeldungen erfassen und auswerten", tax:"K4",
        lz:[
          {k:"1.5.1", t:"ReklamationsgesprÃ¤che fÃ¼hren"},
          {k:"1.5.2", t:"GÃ¤stereklamationen analysieren"},
          {k:"1.5.3", t:"Massnahmen ableiten"},
          {k:"1.5.4", t:"Instrumente zur Erfassung der GÃ¤stezufriedenheit"},
          {k:"1.5.5", t:"Einfache GÃ¤stefeedbacks beantworten"},
          {k:"1.5.6", t:"Werbewirksame Antworten auf Bewertungsplattformen"}
        ]},
      { id:"1.6", titel:"GesprÃ¤che in der zweiten Landessprache fÃ¼hren", tax:"K3",
        lz:[
          {k:"1.6.1", t:"HÃ¶flichkeitskonventionen in der 2. Landessprache"},
          {k:"1.6.2", t:"MÃ¼ndliche Mitteilungen in der 2. Landessprache"},
          {k:"1.6.3", t:"Texte und Dokumente in der 2. Landessprache"},
          {k:"1.6.4", t:"Informationen weiterleiten in der 2. Landessprache"},
          {k:"1.6.5", t:"GesprÃ¤che aus dem Betriebsalltag in der 2. Landessprache"},
          {k:"1.6.6", t:"KundengesprÃ¤ch in der 2. Landessprache"}
        ]},
      { id:"1.7", titel:"GesprÃ¤che in Englisch fÃ¼hren", tax:"K3",
        lz:[
          {k:"1.7.1", t:"HÃ¶flichkeitskonventionen auf Englisch"},
          {k:"1.7.2", t:"MÃ¼ndliche Mitteilungen auf Englisch"},
          {k:"1.7.3", t:"Texte und Dokumente auf Englisch"},
          {k:"1.7.4", t:"Informationen weiterleiten auf Englisch"},
          {k:"1.7.5", t:"GesprÃ¤che aus dem Betriebsalltag auf Englisch"},
          {k:"1.7.6", t:"KundengesprÃ¤ch auf Englisch"}
        ]}
    ]},
  { id:2, code:"HKB 2", color:"#3A6FA0",
    titel:"Gestalten und Organisieren von Marketingmassnahmen",
    kompetenzen:[
      { id:"2.1", titel:"Betriebliche und Kooperationsangebote planen", tax:"K5",
        lz:[
          {k:"2.1.1", t:"Saisonale, betriebliche Angebote und Kooperationsangebote"},
          {k:"2.1.2", t:"Zielgruppen analysieren"},
          {k:"2.1.3", t:"Zielgruppengerechtes Angebot zusammenstellen"},
          {k:"2.1.4", t:"Offerten einholen"},
          {k:"2.1.5", t:"Verschiedene Offerten vergleichen"}
        ]},
      { id:"2.2", titel:"Medien und Kommunikationsmittel gestalten", tax:"K5",
        lz:[
          {k:"2.2.1", t:"WerbetrÃ¤ger entwerfen"},
          {k:"2.2.2", t:"Folien und PrÃ¤sentationen erstellen"},
          {k:"2.2.3", t:"Nutzungsrechte von Quellen (Urheberrecht)"},
          {k:"2.2.4", t:"InformationstrÃ¤ger bestimmen"},
          {k:"2.2.5", t:"InformationstrÃ¤ger bearbeiten"}
        ]},
      { id:"2.3", titel:"Instrumente fÃ¼r die Erhebung der GÃ¤stezufriedenheit erstellen", tax:"K4",
        lz:[
          {k:"2.3.1", t:"Instrument GÃ¤stezufriedenheit analysieren und weiterentwickeln"}
        ]}
    ]},
  { id:3, code:"HKB 3", color:"#5B8C5A",
    titel:"Organisieren und Umsetzen von administrativen Arbeitsprozessen",
    kompetenzen:[
      { id:"3.1", titel:"Grundlagen, Daten und Zahlen fÃ¼r die Administration beschaffen", tax:"K3",
        lz:[
          {k:"3.1.1", t:"Allgemeine GeschÃ¤ftsbedingungen"},
          {k:"3.1.2", t:"Verkaufs- und Stornierungsbedingungen"},
          {k:"3.1.3", t:"BÃ¼romaterial beschaffen"},
          {k:"3.1.4", t:"Daten und Informationen erfassen"},
          {k:"3.1.5", t:"Daten und Informationen bearbeiten"},
          {k:"3.1.6", t:"Datensicherungssysteme"},
          {k:"3.1.7", t:"Den Abteilungen Daten zur VerfÃ¼gung stellen"},
          {k:"3.1.8", t:"Datenschutz und Datensicherheit"},
          {k:"3.1.9", t:"Prozessschritte bei Anfragen"}
        ]},
      { id:"3.2", titel:"Interne und externe Korrespondenz erledigen", tax:"K4",
        lz:[
          {k:"3.2.1", t:"Anfragen zu Dienstleistungen und Produkten bearbeiten"},
          {k:"3.2.3", t:"Betriebliche Korrespondenz verfassen"},
          {k:"3.2.4", t:"Korrespondenz ablegen"},
          {k:"3.2.5", t:"SelbststÃ¤ndig Sitzungen organisieren"},
          {k:"3.2.6", t:"DurchfÃ¼hrung von Sitzungen"},
          {k:"3.2.7", t:"Brief- und Paketpost bearbeiten"},
          {k:"3.2.8", t:"GerÃ¤te im administrativen Bereich bedienen"}
        ]},
      { id:"3.3", titel:"Einfache Finanzbuchhaltung fÃ¼hren", tax:"K4",
        lz:[
          {k:"3.3.1", t:"Erbrachte Leistungen und Zahlungen erfassen"},
          {k:"3.3.2", t:"Kassenabschluss fÃ¼hren"},
          {k:"3.3.3", t:"Buchungsfehler aufdecken"},
          {k:"3.3.4", t:"Korrekturbuchungen durchfÃ¼hren"},
          {k:"3.3.5", t:"Mahnungen erstellen"},
          {k:"3.3.6", t:"Kreditorenrechnungen kontrollieren"},
          {k:"3.3.7", t:"Betriebseigene Angebote kalkulieren"},
          {k:"3.3.8", t:"Break-Even-Point berechnen"}
        ]},
      { id:"3.4", titel:"Bei der Administration der Mitarbeiterdossiers mitarbeiten", tax:"K3",
        lz:[
          {k:"3.4.1", t:"Personalrekrutierung"},
          {k:"3.4.2", t:"Eintritte von Mitarbeitenden"},
          {k:"3.4.3", t:"Austritte von Mitarbeitenden"},
          {k:"3.4.4", t:"Erster Arbeitstag gestalten"},
          {k:"3.4.5", t:"Wiederkehrende Aufgaben Mitarbeiteradministration"}
        ]},
      { id:"3.5", titel:"Betriebliche Statistiken fÃ¼hren", tax:"K4",
        lz:[
          {k:"3.5.1", t:"Kennzahlen beschreiben (Belegung, Ã˜-Preis, RevPAR)"},
          {k:"3.5.3", t:"EinflussmÃ¶glichkeiten im Arbeitsbereich"}
        ]},
      { id:"3.6", titel:"Einfache Texte in der zweiten Landessprache verfassen", tax:"K3",
        lz:[
          {k:"3.6.1", t:"Einfache Texte in der 2. Landessprache verfassen"},
          {k:"3.6.2", t:"Einfache Texte in die 2. Landessprache Ã¼bersetzen"}
        ]},
      { id:"3.7", titel:"Einfache Texte in Englisch verfassen", tax:"K3",
        lz:[
          {k:"3.7.1", t:"Einfache Texte in Englisch verfassen"},
          {k:"3.7.2", t:"Einfache Texte ins Englisch Ã¼bersetzen"}
        ]}
    ]},
  { id:4, code:"HKB 4", color:"#8B6914",
    titel:"Sicherstellen der Nachhaltigkeit und der QualitÃ¤tsvorgaben",
    kompetenzen:[
      { id:"4.1", titel:"Lager nachhaltig bewirtschaften", tax:"K3",
        lz:[
          {k:"4.1.1", t:"LagerrÃ¤umlichkeiten kontrollieren"},
          {k:"4.1.2", t:"Warenannahme und -einlagerung"},
          {k:"4.1.3", t:"Lager nachhaltig bewirtschaften"}
        ]},
      { id:"4.2", titel:"Die betriebliche Werterhaltung sicherstellen", tax:"K3",
        lz:[
          {k:"4.2.1", t:"Organisation der Werterhaltung"},
          {k:"4.2.2", t:"Einfache Reinigungsarbeiten"},
          {k:"4.2.3", t:"Unterhaltsreinigungen"},
          {k:"4.2.4", t:"Maschinen und GerÃ¤te im Hauswirtschaftsbereich"},
          {k:"4.2.5", t:"ArrivÃ©e-, Restant- und DÃ©part-Zimmer"},
          {k:"4.2.7", t:"HACCP-GrundsÃ¤tze"},
          {k:"4.2.8", t:"Auswirkungen von HygienelÃ¼cken"},
          {k:"4.2.9", t:"Hygienevorschriften"}
        ]},
      { id:"4.3", titel:"GrundsÃ¤tze der Nachhaltigkeit sicherstellen", tax:"K4",
        lz:[
          {k:"4.3.1", t:"Gesundheitsschutz und UnfallprÃ¤vention"},
          {k:"4.3.3", t:"Vorgaben zum Schutz der Umwelt"},
          {k:"4.3.4", t:"Betriebliche Vorgaben Umweltschutz vergleichen"},
          {k:"4.3.5", t:"PersÃ¶nliche EinflussmÃ¶glichkeiten auf die Umwelt"},
          {k:"4.3.6", t:"Abfallentsorgung"},
          {k:"4.3.7", t:"Betriebliche Brandschutzvorgaben"},
          {k:"4.3.8", t:"PersÃ¶nliche EinflussmÃ¶glichkeiten auf BrandverhÃ¼tung"},
          {k:"4.3.10", t:"Umwelt und Nachhaltigkeit"},
          {k:"4.3.11", t:"Umwelt und Nachhaltigkeit als Verkaufsargument"}
        ]},
      { id:"4.4", titel:"Betriebliche Werte und Normen umsetzen", tax:"K4",
        lz:[
          {k:"4.4.1", t:"Betriebliche Werte und Normen"},
          {k:"4.4.2", t:"Image des Betriebs"},
          {k:"4.4.3", t:"QualitÃ¤tsstandards"}
        ]}
    ]}
];
const ALL_HK = BP.flatMap(h=>h.kompetenzen);
const ALL_LZ_KEYS = ALL_HK.flatMap(hk=>hk.lz.map(l=>l.k));

// Bildungsbericht Kriterien (exakt nach SDBB-Vorlage)
const BB_KRITERIEN = {
  fach: {
    label:"1. Fachkompetenz", color:"#C9A84C",
    items:[
      {k:"fach_1", label:"1.1 Ausbildungsstand", desc:"Gesamtbeurteilung gemÃ¤ss den im Bildungsplan aufgefÃ¼hrten Bildungszielen"},
      {k:"fach_2", label:"1.2 ArbeitsqualitÃ¤t", desc:"Genauigkeit/Sorgfalt"},
      {k:"fach_3", label:"1.3 Arbeitsmenge, Arbeitstempo", desc:"Zeitaufwand fÃ¼r sachgerechte AusfÃ¼hrung der Arbeiten"},
      {k:"fach_4", label:"1.4 Umsetzung der Berufskenntnisse", desc:"Verbindung von Theorie und Praxis"}
    ]},
  methode: {
    label:"2. Methodenkompetenz", color:"#3A6FA0",
    items:[
      {k:"meth_1", label:"2.1 Arbeitstechnik", desc:"Arbeitsplatzgestaltung/Einsatz der Mittel/Reflexion der AuftrÃ¤ge/RÃ¼ckfragen"},
      {k:"meth_2", label:"2.2 Vernetztes Denken und Handeln", desc:"Verstehen von ArbeitsablÃ¤ufen/Eigene BeitrÃ¤ge/VerbesserungsvorschlÃ¤ge"},
      {k:"meth_3", label:"2.3 Umgang mit Mitteln und Betriebseinrichtungen", desc:"Ã–kologisches Verhalten/Materialverbrauch/Sorgfalt/Pflege der Einrichtungen"},
      {k:"meth_4", label:"2.4 Lern- und Arbeitsstrategie", desc:"Bewusste Steuerung der eigenen Lernprozesse/Prozesse erklÃ¤ren und prÃ¤sentieren"}
    ]},
  sozial: {
    label:"3. Sozialkompetenz", color:"#5B8C5A",
    items:[
      {k:"soz_1", label:"3.1 TeamfÃ¤higkeit, KonfliktfÃ¤higkeit", desc:"Beitrag zum Betriebsklima/Ehrlichkeit/Umgang mit Kritik"},
      {k:"soz_2", label:"3.2 Zusammenarbeit", desc:"VerstÃ¤ndnis fÃ¼r andere/Empathie"},
      {k:"soz_3", label:"3.3 Information und Kommunikation", desc:"Sich verstÃ¤ndlich ausdrÃ¼cken/BerÃ¼cksichtigen der Sichtweise anderer"},
      {k:"soz_4", label:"3.4 Kundenorientiertes Handeln", desc:"Umgang mit Kunden/KundenbedÃ¼rfnisse erfassen/Hilfsbereitschaft"}
    ]},
  selbst: {
    label:"4. Selbstkompetenz", color:"#8B6914",
    items:[
      {k:"selbst_1", label:"4.1 SelbststÃ¤ndigkeit, eigenverantwortliches Handeln", desc:"Eigeninitiative/Verantwortungsbewusstsein/Eigene BeitrÃ¤ge"},
      {k:"selbst_2", label:"4.2 ZuverlÃ¤ssigkeit, Belastbarkeit", desc:"PÃ¼nktlichkeit/Termineinhaltung/Durchhaltewillen"},
      {k:"selbst_3", label:"4.3 Umgangsformen", desc:"Situationsgerechtes Verhalten/Freundlichkeit/Ã„ussere Erscheinung"},
      {k:"selbst_4", label:"4.4 Motivation", desc:"Einstellung zum Beruf/BegeisterungsfÃ¤higkeit/Lernbereitschaft"}
    ]},
  lerndoku: {
    label:"5. Lerndokumentation", color:"#9B5E8C",
    items:[
      {k:"ldk_1", label:"5.1 Sachliche Richtigkeit, VollstÃ¤ndigkeit", desc:""},
      {k:"ldk_2", label:"5.2 Sauberkeit, Darstellung, Ãœbersichtlichkeit", desc:""}
    ]},
  schule: {
    label:"6. Leistungen in Schule und Ã¼K", color:"#4A8080",
    items:[
      {k:"sch_1", label:"6.1 Semesterzeugnis", desc:""},
      {k:"sch_2", label:"6.2 Ãœberbetriebliche Kurse (Ã¼K)", desc:""},
      {k:"sch_3", label:"6.3 Freikurse, StÃ¼tzkurse", desc:""}
    ]}
};
const ALL_BB_ITEMS = Object.values(BB_KRITERIEN).flatMap(d=>d.items);
const ABCD_LABEL = {A:"A â€“ Anforderungen Ã¼bertroffen",B:"B â€“ Anforderungen erfÃ¼llt",C:"C â€“ knapp erfÃ¼llt, FÃ¶rdermassnahmen nÃ¶tig",D:"D â€“ nicht erfÃ¼llt, besondere Massnahmen nÃ¶tig"};

const ABTEILUNGEN = [
  {id:"kueche",        label:"KÃ¼che",          icon:"ğŸ³"},
  {id:"service",       label:"Service/F&B",    icon:"ğŸ½ï¸"},
  {id:"housekeeping",  label:"Housekeeping",   icon:"ğŸ›ï¸"},
  {id:"reception",     label:"Reception",      icon:"ğŸ›ï¸"},
  {id:"administration",label:"Administration", icon:"ğŸ’¼"}
];

const QV_SZENARIEN_DEFAULT = [
  {id:"s1",titel:"CPEX Situation 1: Check-in mit Sonderwunsch",hkbs:[1,3],beschreibung:"Gast mit Sonderwunsch beim Check-in. Upgrade, Allergieinfo, Reklamation.",
   aufgaben:["BegrÃ¼ssung und Identifikation des Gastes simulieren","Upgrade-GesprÃ¤ch mit Upselling-Argumenten Ã¼ben","Reklamation professionell abhandeln","Check-in-Prozess im PMS vollstÃ¤ndig durchfÃ¼hren","Schriftliche Notiz fÃ¼r Housekeeping erstellen"]},
  {id:"s2",titel:"CPEX Situation 2: Reservierung & Korrespondenz",hkbs:[1,2],beschreibung:"Telefonische Gruppenreservierung, Offerte erstellen, BestÃ¤tigungsmail verfassen.",
   aufgaben:["Telefonisches ReservierungsgesprÃ¤ch Ã¼ben","Gruppenofferte mit Preiskalkulation erstellen","BestÃ¤tigungs-E-Mail auf Deutsch verfassen","BestÃ¤tigungs-E-Mail auf Englisch verfassen","Stornierungsbedingungen kommunizieren"]},
  {id:"s3",titel:"CPEX Situation 3: Nachhaltigkeit & QualitÃ¤t",hkbs:[4],beschreibung:"Nachhaltigkeitsprojekt vorstellen, Kontrollgang, QualitÃ¤tsmÃ¤ngel beheben.",
   aufgaben:["Nachhaltigkeitsmassnahmen des Betriebs prÃ¤sentieren","Kontrollgang Zimmer: Fehler entdecken und dokumentieren","HACCP-Checkliste fÃ¼r F&B Bereich ausfÃ¼llen","Verkaufsargument Nachhaltigkeit im GÃ¤stegesprÃ¤ch Ã¼ben","QualitÃ¤tsprotokoll erstellen"]},
  {id:"s4",titel:"PEX: FachgesprÃ¤ch mit Expertinnen",hkbs:[1,2,3,4],beschreibung:"40-minÃ¼tiges FachgesprÃ¤ch zu allen 4 HKBs.",
   aufgaben:["3 eigene Lernberichte zur PrÃ¤sentation vorbereiten","Selbstreflexion zu StÃ¤rken und Entwicklungsfeldern formulieren","Betriebsrundgang vorbereiten","Kennzahlen des Betriebs erklÃ¤ren kÃ¶nnen","Fremdsprachige Szenarien vorbereiten","PersÃ¶nliche Berufsziele formulieren"]}
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let user = null, userProfile = null; // userProfile = {role:'admin'|'abt', abteilung:'kueche'|...}
let currentLid = null;
let bpSemFilter = 0;
let currentBerichtId = null;
let epView = 'month'; // 'month'|'week'|'day'
let epMonthOff = 0, epWeekOff = 0, epDayOff = 0;
let epSelectedCell = null;
let S = {
  lehrlinge:[], lernberichte:[], lzStatus:{},
  bewertungen:{}, einsatzplan:{}, termine:[],
  einstellungen:{apiKey:'',qvDatum:'2026-07-01'},
  szenarien:[], // custom QV Szenarien
  benutzer:[]   // Benutzer-Rollen
};
let kiHistory = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const uid = ()=>user?.uid;
const rj = async p=>{const s=await getDoc(doc(db,p));return s.exists()?s.data():null;};
const wj = async(p,d)=>setDoc(doc(db,p),d,{merge:true});
const col = async p=>{const s=await getDocs(collection(db,p));return s.docs.map(d=>({id:d.id,...d.data()}));};
const add = async(p,d)=>{const r=await addDoc(collection(db,p),{...d,_ts:serverTimestamp()});return r.id;};
const del = async p=>deleteDoc(doc(db,p));
const upd = async(p,d)=>updateDoc(doc(db,p),d);

async function loadAll() {
  const [l,b,lz,bew,ep,t,ein,sz,ben] = await Promise.all([
    col(`users/${uid()}/lehrlinge`),col(`users/${uid()}/lernberichte`),
    rj(`users/${uid()}/lzStatus/data`),rj(`users/${uid()}/bewertungen/data`),
    rj(`users/${uid()}/einsatzplan/data`),col(`users/${uid()}/termine`),
    rj(`users/${uid()}/einstellungen/data`),
    col(`users/${uid()}/szenarien`),
    col(`users/${uid()}/benutzer`)
  ]);
  S.lehrlinge=l||[];S.lernberichte=b||[];S.lzStatus=lz||{};
  S.bewertungen=bew||{};S.einsatzplan=ep||{};S.termine=t||[];
  S.einstellungen=ein||{apiKey:'',qvDatum:'2026-07-01'};
  S.szenarien=sz||[];S.benutzer=ben||[];
  if(!currentLid&&S.lehrlinge.length)currentLid=S.lehrlinge[0].id;
  // Lade eigenes Profil
  const prof=await rj(`profiles/${uid()}`);
  userProfile=prof||{role:'admin',abteilung:null};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getLZForSem(sem) {
  // Gibt alle LZ-Keys zurÃ¼ck die diesem Semester zugeordnet sind
  return ALL_LZ_KEYS.filter(k=>LZ_SEM[k]&&LZ_SEM[k].includes(sem));
}
function calcSemProgress(lid, sem) {
  const lz=S.lzStatus[lid]||{};
  const semLZs=getLZForSem(sem);
  if(!semLZs.length)return{done:0,total:0,pct:0,complete:false};
  const done=semLZs.filter(k=>lz[k]).length;
  return{done,total:semLZs.length,pct:Math.round(done/semLZs.length*100),complete:done===semLZs.length};
}
function calcHKStatus(lid){
  const lz=S.lzStatus[lid]||{};
  const r={};
  ALL_HK.forEach(hk=>{
    const keys=hk.lz.map(l=>l.k);
    const done=keys.filter(k=>lz[k]).length;
    r[hk.id]=done===0?0:done===keys.length?2:1;
  });
  return r;
}
function calcLZProg(lid){
  const lz=S.lzStatus[lid]||{};
  const done=ALL_LZ_KEYS.filter(k=>lz[k]).length;
  return{done,total:ALL_LZ_KEYS.length,pct:Math.round(done/ALL_LZ_KEYS.length*100)};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoading(v){document.getElementById('loading').style.display=v?'flex':'none';}
let toastTm;
function toast(msg,type='green'){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast '+(type==='green'?'ok':type==='red'?'err':'warn');
  t.classList.add('show');clearTimeout(toastTm);toastTm=setTimeout(()=>t.classList.remove('show'),2800);
}
function openModal(id){document.getElementById('modal-'+id).classList.add('open');}
function closeModal(id){document.getElementById('modal-'+id).classList.remove('open');}
function fmtDate(iso){if(!iso)return'â€“';return new Date(iso).toLocaleDateString('de-CH',{day:'numeric',month:'long',year:'numeric'});}
function fmtSize(b){return b<1024?b+'B':b<1048576?(b/1024).toFixed(1)+'KB':(b/1048576).toFixed(1)+'MB';}
function fileIcon(n=''){return/\.pdf$/i.test(n)?'ğŸ“„':/\.(jpg|jpeg|png|gif|webp)$/i.test(n)?'ğŸ–¼ï¸':'ğŸ“';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
onAuthStateChanged(auth,async u=>{
  user=u;
  if(u){
    document.getElementById('auth-screen').style.display='none';
    document.getElementById('app').style.display='block';
    document.getElementById('user-email').textContent=u.email;
    showLoading(true);await loadAll();showLoading(false);
    renderAll();
    // Zeige/verstecke Admin-MenÃ¼
    const isAdmin=userProfile?.role==='admin';
    document.getElementById('tab-benutzer').style.display=isAdmin?'':'none';
  }else{
    document.getElementById('auth-screen').style.display='flex';
    document.getElementById('app').style.display='none';
  }
});
async function login(){
  const e=document.getElementById('auth-email').value.trim(),p=document.getElementById('auth-pw').value;
  document.getElementById('auth-err').textContent='';
  try{await signInWithEmailAndPassword(auth,e,p);}
  catch(er){document.getElementById('auth-err').textContent=er.code==='auth/invalid-credential'?'E-Mail oder Passwort falsch.':er.message;}
}
async function register(){
  const e=document.getElementById('auth-email').value.trim(),p=document.getElementById('auth-pw').value;
  const err=document.getElementById('auth-err');err.textContent='';
  if(p.length<6){err.textContent='Passwort mind. 6 Zeichen.';return;}
  try{await createUserWithEmailAndPassword(auth,e,p);}
  catch(ex){err.textContent=ex.code==='auth/email-already-in-use'?'E-Mail bereits registriert.':ex.message;}
}
async function logout(){
  await signOut(auth);
  S={lehrlinge:[],lernberichte:[],lzStatus:{},bewertungen:{},einsatzplan:{},termine:[],einstellungen:{},szenarien:[],benutzer:[]};
  kiHistory=[];userProfile=null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(id,el){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('sec-'+id).classList.add('active');
  if(el)el.classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEHRLING BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeLB(id){
  const el=document.getElementById(id);if(!el)return;
  el.innerHTML=S.lehrlinge.map(l=>`
    <div class="lp ${l.id===currentLid?'active':''}" onclick="window.selectL('${l.id}')">
      <div class="lav" style="background:${l.color||'#555'}">${l.initials}</div>
      <div><div style="font-size:12px;font-weight:500;">${l.vorname} ${l.nachname}</div>
      <div class="dim" style="font-size:10px;">${l.lj}. Lehrjahr</div></div>
    </div>`).join('');
}
function selectL(lid){currentLid=lid;renderAll();}
function fillDropdowns(){
  ['nb-lid'].forEach(id=>{const el=document.getElementById(id);if(!el)return;
    el.innerHTML=S.lehrlinge.map(l=>`<option value="${l.id}">${l.vorname} ${l.nachname}</option>`).join('');
    if(currentLid)el.value=currentLid;});
  const hkSel=document.getElementById('nb-hk');
  if(hkSel)hkSel.innerHTML='<option value="">â€” Keine Angabe â€”</option>'+
    ALL_HK.map(hk=>`<option value="${hk.id}">HK ${hk.id}: ${hk.titel.substring(0,45)}</option>`).join('');
  const tmLid=document.getElementById('tm-lid');
  if(tmLid)tmLid.innerHTML=S.lehrlinge.map(l=>`<option value="${l.id}">${l.vorname} ${l.nachname}</option>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ÃœBERSICHT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOverview(){
  makeLB('ov-lb');
  if(!currentLid)return;
  const l=S.lehrlinge.find(x=>x.id===currentLid);if(!l)return;
  const b=S.lernberichte.filter(x=>x.lid===currentLid);
  const lzP=calcLZProg(currentLid);
  const hkSt=calcHKStatus(currentLid);
  const hkDone=Object.values(hkSt).filter(v=>v===2).length;
  const days=Math.max(0,Math.ceil((new Date(S.einstellungen.qvDatum||'2026-07-01')-new Date())/86400000));

  document.getElementById('ov-stats').innerHTML=`
    <div class="sc" style="--a:#C9A84C"><div class="sc-n" style="color:#C9A84C">${l.lj}.</div><div class="sc-l">Lehrjahr</div><div class="dim sc-s">Start ${l.start}</div></div>
    <div class="sc" style="--a:#5B8C5A"><div class="sc-n" style="color:#7EC07E">${b.filter(x=>x.status==='visiert').length}/${b.length}</div><div class="sc-l">Lernberichte</div><div class="dim sc-s">visiert / total</div></div>
    <div class="sc" style="--a:#3A6FA0"><div class="sc-n" style="color:#5A8FC0">${lzP.pct}%</div><div class="sc-l">Leistungsziele</div><div class="dim sc-s">${lzP.done}/${lzP.total} Â· ${hkDone}/21 HK âœ“</div></div>
    <div class="sc" style="--a:#C9A84C"><div class="sc-n" style="color:#C9A84C">${days}</div><div class="sc-l">Tage bis QV</div><div class="dim sc-s">${S.einstellungen.qvDatum||'2026-07-01'}</div></div>`;

  // Semester-Fortschritt
  let semHtml='<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:14px;">';
  for(let s=1;s<=6;s++){
    const sp=calcSemProgress(currentLid,s);
    const cls=sp.complete?'tg':sp.pct>0?'ty':'tr';
    semHtml+=`<div style="background:var(--bg2);border:1px solid var(--border);border-radius:9px;padding:10px;text-align:center;">
      <div style="font-size:18px;font-weight:700;color:${sp.complete?'var(--green-l)':sp.pct>0?'#E0B840':'var(--dim)'};">${sp.complete?'âœ“':sp.pct+'%'}</div>
      <div style="font-size:10px;color:var(--dim);margin-top:2px;">Semester ${s}</div>
      <div style="font-size:10px;color:var(--dim);">${sp.done}/${sp.total} LZ</div>
    </div>`;
  }
  semHtml+='</div>';

  let ph='';
  BP.forEach(hkb=>{
    const ids=hkb.kompetenzen.map(k=>k.id);
    const d=ids.filter(id=>hkSt[id]===2).length;
    const p=ids.filter(id=>hkSt[id]===1).length;
    const pct=Math.round((d+p*.5)/ids.length*100);
    ph+=`<div class="pw"><div class="prow"><span>${hkb.code}</span><span class="dim">${pct}%</span></div>
      <div class="pbar"><div class="pfill" style="width:${pct}%;background:${hkb.color}"></div></div></div>`;
  });

  const now=new Date().toISOString().slice(0,10);
  const upcoming=S.termine.filter(t=>t.lid===currentLid&&t.datum>=now).sort((a,b2)=>a.datum.localeCompare(b2.datum)).slice(0,3);
  let tasks='';
  b.filter(x=>x.status==='eingereicht').forEach(x=>{tasks+=`<div class="task-row">ğŸ“ <div style="flex:1"><b>${x.thema||'Lernbericht'}</b> wartet auf Visum</div><span class="tag ty">PrÃ¼fen</span></div>`;});
  upcoming.forEach(t=>{tasks+=`<div class="task-row">ğŸ“… <div style="flex:1"><b>${fmtDate(t.datum)}</b>: ${t.titel}</div><span class="tag tb">Termin</span></div>`;});
  if(!tasks)tasks='<div style="text-align:center;padding:16px;color:var(--green-l);font-size:12px;">âœ“ Keine offenen Aufgaben</div>';

  document.getElementById('ov-sem').innerHTML=semHtml;
  document.getElementById('ov-prog').innerHTML=ph;
  document.getElementById('ov-tasks').innerHTML=tasks;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BILDUNGSPLAN (Semester-Filter mit exakten LZ-Codes)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBildungsplan(){
  makeLB('bp-lb');
  if(!currentLid)return;
  const lid=currentLid, lz=S.lzStatus[lid]||{};
  const lzP=calcLZProg(lid);
  const l=S.lehrlinge.find(x=>x.id===lid);

  document.getElementById('bp-sub').textContent=l?`${l.vorname} ${l.nachname} Â· ${lzP.done}/${lzP.total} LZ (${lzP.pct}%)`:'â€”';
  document.getElementById('bp-total-bar').style.width=lzP.pct+'%';
  document.getElementById('bp-total-lbl').textContent=lzP.pct+'%';

  // Semester-Buttons mit Fortschritt
  let semBtns=`<button class="sem-btn ${bpSemFilter===0?'active':''}" onclick="window.setBpSem(0)">Alle</button>`;
  for(let s=1;s<=6;s++){
    const sp=calcSemProgress(lid,s);
    semBtns+=`<button class="sem-btn ${bpSemFilter===s?'active':''}" onclick="window.setBpSem(${s})">
      S${s} ${sp.complete?'âœ“':sp.pct+'%'}
    </button>`;
  }
  document.getElementById('bp-sem-btns').innerHTML=semBtns;

  // Filtern nach Semester
  let html='';
  BP.forEach(hkb=>{
    // Welche HKs haben LZs in diesem Semester?
    const filteredHKs=hkb.kompetenzen.map(hk=>{
      const filteredLZ=bpSemFilter===0?hk.lz:hk.lz.filter(l2=>LZ_SEM[l2.k]&&LZ_SEM[l2.k].includes(bpSemFilter));
      return{...hk,lzFiltered:filteredLZ};
    }).filter(hk=>hk.lzFiltered.length>0);
    if(!filteredHKs.length)return;

    const hkbLZKs=filteredHKs.flatMap(hk=>hk.lzFiltered.map(l2=>l2.k));
    const hkbDone=hkbLZKs.filter(k=>lz[k]).length;
    html+=`<div class="hkb-block">
      <div class="hkb-hd" onclick="window.this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')" style="border-left:3px solid ${hkb.color}">
        <span class="hkb-code" style="color:${hkb.color}">${hkb.code}</span>
        <span class="hkb-t">${hkb.titel}</span>
        <span class="dim" style="font-size:11px;">${hkbDone}/${hkbLZKs.length} LZ</span>
        <span class="chev">â–¶</span>
      </div>
      <div class="hkb-body">`;

    filteredHKs.forEach(hk=>{
      const lzKeys=hk.lzFiltered.map(l2=>l2.k);
      const done=lzKeys.filter(k=>lz[k]).length;
      const isDone=done===hk.lzFiltered.length,isP=done>0&&!isDone;
      const semTags=bpSemFilter===0?[...new Set(hk.lz.flatMap(l2=>LZ_SEM[l2.k]||[]))].sort().map(s=>`<span class="hk-tax" style="color:var(--blue-l)">S${s}</span>`).join(''):'';
      html+=`<div class="hk-row">
        <div class="hk-st ${isDone?'done':isP?'part':''}">${isDone?'âœ“':isP?'â—':''}</div>
        <div class="hk-body">
          <div class="hk-meta"><span class="hk-code">HK ${hk.id}</span><span class="hk-tax">${hk.tax}</span>${semTags}</div>
          <div class="hk-t" onclick="window.toggleLL('ll-${hk.id.replace('.','_')}')">${hk.titel}</div>
          <div class="hk-prog">${done}/${hk.lzFiltered.length} LZ<span class="dim" style="cursor:pointer;" onclick="window.toggleLL('ll-${hk.id.replace('.','_')}')"> â–¾ aufklappen</span></div>
          <div class="lz-list" id="ll-${hk.id.replace('.','_')}">
            ${hk.lzFiltered.map(lzItem=>{
              const chk=!!lz[lzItem.k];
              const semLabel=LZ_SEM[lzItem.k]?LZ_SEM[lzItem.k].map(s=>`S${s}`).join(','):'';
              return `<div class="lz-row" onclick="window.toggleLZ('${lid}','${lzItem.k}',this)">
                <div class="lz-cb ${chk?'on':''}">${chk?'âœ“':''}</div>
                <div class="lz-t ${chk?'done-t':''}">${lzItem.k} ${lzItem.t}<span class="dim" style="font-size:9px;margin-left:4px;">[${semLabel}]</span></div>
              </div>`;
            }).join('')}
          </div>
        </div>
      </div>`;
    });
    html+=`</div></div>`;
  });
  document.getElementById('bp-hkb').innerHTML=html||'<div class="dim" style="padding:20px;text-align:center;">Keine Leistungsziele fÃ¼r dieses Semester.</div>';
}
function setBpSem(n){bpSemFilter=n;renderBildungsplan();}
function toggleLL(id){document.getElementById(id)?.classList.toggle('open');}

async function toggleLZ(lid,key,rowEl){
  if(!S.lzStatus[lid])S.lzStatus[lid]={};
  const v=!S.lzStatus[lid][key];
  S.lzStatus[lid][key]=v;
  const cb=rowEl.querySelector('.lz-cb'),txt=rowEl.querySelector('.lz-t');
  cb.classList.toggle('on',v);cb.textContent=v?'âœ“':'';
  txt.classList.toggle('done-t',v);
  // Update HK
  const hkId=key.split('.').slice(0,2).join('.');
  const hk=ALL_HK.find(h=>h.id===hkId);
  if(hk){
    const lzKeys=hk.lz.map(l2=>l2.k);
    const done=lzKeys.filter(k=>S.lzStatus[lid]?.[k]).length;
    const hkRow=rowEl.closest('.hk-row');
    const st=hkRow?.querySelector('.hk-st'),pg=hkRow?.querySelector('.hk-prog');
    if(st){const isDone=done===hk.lz.length,isP=done>0&&!isDone;st.className=`hk-st ${isDone?'done':isP?'part':''}`;st.textContent=isDone?'âœ“':isP?'â—':'';}
    if(pg){const suf=pg.innerHTML.split('LZ')[1];pg.innerHTML=`${done}/${bpSemFilter===0?hk.lz.length:hk.lz.filter(l2=>LZ_SEM[l2.k]?.includes(bpSemFilter)).length} LZ${suf}`;}
  }
  const lzP=calcLZProg(lid);
  document.getElementById('bp-total-bar').style.width=lzP.pct+'%';
  document.getElementById('bp-total-lbl').textContent=lzP.pct+'%';
  const sub=document.getElementById('bp-sub'),ll=S.lehrlinge.find(x=>x.id===lid);
  if(sub&&ll)sub.textContent=`${ll.vorname} ${ll.nachname} Â· ${lzP.done}/${lzP.total} LZ (${lzP.pct}%)`;
  // Update Semester-Buttons
  const semBtnsEl=document.getElementById('bp-sem-btns');
  if(semBtnsEl){
    for(let s=1;s<=6;s++){
      const sp=calcSemProgress(lid,s);
      const btn=semBtnsEl.children[s];
      if(btn)btn.innerHTML=`S${s} ${sp.complete?'âœ“':sp.pct+'%'}`;
    }
  }
  await wj(`users/${uid()}/lzStatus/data`,S.lzStatus);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LERNBERICHTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLernberichte(){
  makeLB('lb-lb');
  if(!currentLid)return;
  const bs=S.lernberichte.filter(b=>b.lid===currentLid);
  let html='<div class="b-sem-grid">';
  for(let sem=1;sem<=6;sem++){
    const semB=bs.filter(b=>b.sem==sem);
    const sp=calcSemProgress(currentLid,sem);
    html+=`<div class="b-sem">
      <div class="b-sem-lbl">Semester ${sem}
        <span class="tag ${sp.complete?'tg':sp.pct>0?'ty':'tb'}" style="margin-left:4px;font-size:9px;">${sp.complete?'âœ“ LZ fertig':sp.pct+'% LZ'}</span>
      </div>`;
    semB.forEach(b=>{
      const si={visiert:'âœ…',eingereicht:'ğŸ“„',offen:'â—‹'};
      html+=`<div class="b-card ${b.status}" onclick="window.showBericht('${b.id}')">
        <div style="font-size:15px;">${si[b.status]||'â—‹'}</div>
        <div style="font-size:11px;line-height:1.3;margin-top:3px;">${(b.thema||'â€“').substring(0,28)}</div>
        <div style="font-size:10px;color:var(--gold);">${b.hk?'HK '+b.hk:''}</div>
      </div>`;
    });
    html+=`<div class="b-card add" onclick="window.openNewBericht(${sem})">+ Neu</div></div>`;
  }
  html+='</div>';
  document.getElementById('b-grid').innerHTML=html;
}
function openNewBericht(sem){
  ['nb-thema','nb-pos','nb-verb'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('nb-edit-id').value='';
  document.getElementById('nb-modal-title').textContent='Neuer Lernbericht';
  if(sem)document.getElementById('nb-sem').value=sem;
  if(currentLid)document.getElementById('nb-lid').value=currentLid;
  document.getElementById('nb-status').value='eingereicht';
  openModal('bericht');
}
function editBericht(bid){
  const b=S.lernberichte.find(x=>x.id===bid);if(!b)return;
  document.getElementById('nb-edit-id').value=bid;
  document.getElementById('nb-modal-title').textContent='Lernbericht bearbeiten';
  document.getElementById('nb-lid').value=b.lid;
  document.getElementById('nb-sem').value=b.sem;
  document.getElementById('nb-hk').value=b.hk||'';
  document.getElementById('nb-thema').value=b.thema||'';
  document.getElementById('nb-status').value=b.status;
  document.getElementById('nb-pos').value=b.pos||'';
  document.getElementById('nb-verb').value=b.verb||'';
  openModal('bericht');
}
async function saveBericht(){
  const eid=document.getElementById('nb-edit-id').value;
  const data={lid:document.getElementById('nb-lid').value,sem:parseInt(document.getElementById('nb-sem').value),
    thema:document.getElementById('nb-thema').value.trim(),hk:document.getElementById('nb-hk').value,
    status:document.getElementById('nb-status').value,pos:document.getElementById('nb-pos').value,
    verb:document.getElementById('nb-verb').value};
  if(!data.thema){toast('Bitte Thema eingeben','red');return;}
  showLoading(true);
  if(eid){
    await upd(`users/${uid()}/lernberichte/${eid}`,data);
    const idx=S.lernberichte.findIndex(x=>x.id===eid);
    if(idx>-1)S.lernberichte[idx]={...S.lernberichte[idx],...data};
    toast('âœ“ Bericht aktualisiert');
  }else{
    data.datum=new Date().toISOString().slice(0,10);data.attachments=[];
    const id=await add(`users/${uid()}/lernberichte`,data);
    S.lernberichte.push({id,...data});toast('âœ“ Bericht gespeichert');
  }
  showLoading(false);closeModal('bericht');renderLernberichte();
  if(currentBerichtId)showBericht(eid||currentBerichtId);
}
function showBericht(bid){
  currentBerichtId=bid;
  const b=S.lernberichte.find(x=>x.id===bid);if(!b)return;
  const att=b.attachments||[];
  const sc={visiert:'tg',eingereicht:'ty',offen:'tb'};
  const detail=document.getElementById('b-detail');
  detail.style.display='block';
  detail.className='card';
  detail.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;">
      <div><div style="font-family:'DM Serif Display',serif;font-size:17px;">${b.thema||'(kein Titel)'}</div>
      <div class="dim" style="font-size:11px;">Semester ${b.sem}${b.hk?' Â· HK '+b.hk:''}${b.datum?' Â· '+fmtDate(b.datum):''}</div></div>
      <div style="display:flex;gap:5px;align-items:center;">
        <span class="tag ${sc[b.status]||'tb'}">${{visiert:'âœ… Visiert',eingereicht:'ğŸ“„ Eingereicht',offen:'â—‹ Offen'}[b.status]||b.status}</span>
        <button class="btn btn-out btn-sm" onclick="window.editBericht('${bid}')">âœï¸</button>
        <button class="btn btn-sm" style="background:transparent;border:1px solid var(--red);color:var(--red-l);" onclick="window.deleteBericht('${bid}')">ğŸ—‘</button>
      </div>
    </div>
    ${b.pos?`<div class="bd-sec"><div class="bd-sec-lbl">Positiv aufgefallen</div><div class="bd-sec-body ok">${b.pos}</div></div>`:''}
    ${b.verb?`<div class="bd-sec"><div class="bd-sec-lbl">VerbesserungsmÃ¶glichkeiten</div><div class="bd-sec-body warn">${b.verb}</div></div>`:''}
    ${b.status==='eingereicht'?`<div class="bd-sec"><div class="bd-sec-lbl" style="color:var(--gold)">âœï¸ Jetzt visieren</div>
      <textarea class="fi" id="fb-pos" placeholder="Positiv aufgefallen..."></textarea>
      <textarea class="fi" id="fb-verb" placeholder="VerbesserungsmÃ¶glichkeiten..." style="margin-top:6px;"></textarea>
      <button class="btn btn-gold" style="margin-top:8px;" onclick="window.visiereBericht('${bid}')">âœ“ Visieren</button>
    </div>`:''}
    <div class="divider"></div>
    <div class="bd-sec-lbl">ğŸ“ AnhÃ¤nge (${att.length})</div>
    ${att.length?`<div class="att-list">${att.map(a=>`<div class="att-item">
      <span>${fileIcon(a.name)}</span>
      <a href="${a.url}" target="_blank" class="att-name">${a.name}</a>
      <span class="dim">${fmtSize(a.size||0)}</span>
      <button class="btn btn-out btn-sm" onclick="window.delAtt('${bid}','${a.name}','${encodeURIComponent(a.path||'')}')">âœ•</button>
    </div>`).join('')}</div>`:'<div class="dim" style="font-size:12px;margin:8px 0;">Noch keine AnhÃ¤nge.</div>'}
    <div class="att-zone" onclick="window.document.getElementById('att-f').click()"
      ondragover="window.event.preventDefault();this.classList.add('drag')"
      ondragleave="window.this.classList.remove('drag')"
      ondrop="window.dropAtt(event,'${bid}')">â˜ï¸ PDF oder Bild ablegen / klicken</div>
    <input type="file" id="att-f" multiple accept=".pdf,image/*" style="display:none" onchange="window.uploadAtt(event,'${bid}')">`;
}
async function visiereBericht(bid){
  const pos=document.getElementById('fb-pos')?.value||'',verb=document.getElementById('fb-verb')?.value||'';
  await upd(`users/${uid()}/lernberichte/${bid}`,{status:'visiert',pos,verb});
  const b=S.lernberichte.find(x=>x.id===bid);if(b){b.status='visiert';b.pos=pos;b.verb=verb;}
  toast('âœ“ Bericht visiert');renderLernberichte();showBericht(bid);
}
async function deleteBericht(bid){
  if(!confirm('Bericht lÃ¶schen?'))return;
  await del(`users/${uid()}/lernberichte/${bid}`);
  S.lernberichte=S.lernberichte.filter(x=>x.id!==bid);
  document.getElementById('b-detail').style.display='none';
  currentBerichtId=null;toast('Bericht gelÃ¶scht');renderLernberichte();
}
async function uploadAtt(event,bid){await doUpload(Array.from(event.target.files),bid);}
async function dropAtt(event,bid){event.preventDefault();event.currentTarget.classList.remove('drag');await doUpload(Array.from(event.dataTransfer.files),bid);}
async function doUpload(files,bid){
  if(!files.length)return;showLoading(true);
  const b=S.lernberichte.find(x=>x.id===bid);if(!b)return;
  if(!b.attachments)b.attachments=[];
  for(const file of files){
    const sRef=ref(stor,`users/${uid()}/${bid}/${Date.now()}_${file.name}`);
    await uploadBytes(sRef,file);const url=await getDownloadURL(sRef);
    b.attachments.push({name:file.name,url,size:file.size,path:sRef.fullPath});
  }
  await upd(`users/${uid()}/lernberichte/${bid}`,{attachments:b.attachments});
  showLoading(false);toast(`âœ“ ${files.length} Datei(en) hochgeladen`);showBericht(bid);
}
async function delAtt(bid,name,encodedPath){
  if(!confirm(`"${name}" lÃ¶schen?`))return;
  const b=S.lernberichte.find(x=>x.id===bid);if(!b)return;
  const path=decodeURIComponent(encodedPath);
  if(path){try{await deleteObject(ref(stor,path));}catch(e){}}
  b.attachments=(b.attachments||[]).filter(a=>a.name!==name);
  await upd(`users/${uid()}/lernberichte/${bid}`,{attachments:b.attachments});
  toast('Anhang gelÃ¶scht');showBericht(bid);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BILDUNGSBERICHT (vollstÃ¤ndig nach SDBB-Vorlage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBildungsbericht(){
  makeLB('bb-lb');
  if(!currentLid)return;
  const bew=S.bewertungen[currentLid]||{};
  const isAdmin=userProfile?.role==='admin';
  const myAbt=userProfile?.abteilung;

  // Rolle/Abteilung Anzeige
  const roleInfo=isAdmin
    ?`<div class="card" style="margin-bottom:14px;border-color:var(--gold)"><div style="display:flex;align-items:center;gap:10px;"><div style="font-size:20px;">ğŸ‘¤</div><div><div style="font-size:13px;font-weight:600;">Berufsbildner (Admin)</div><div class="dim" style="font-size:11px;">Siehst alle Abteilungsbewertungen und gibst die finale Beurteilung ab</div></div></div></div>`
    :(()=>{const abt=ABTEILUNGEN.find(a=>a.id===myAbt);return`<div class="card" style="margin-bottom:14px;border-color:var(--blue-l)"><div style="display:flex;align-items:center;gap:10px;"><div style="font-size:20px;">${abt?.icon||'ğŸ¢'}</div><div><div style="font-size:13px;font-weight:600;">${abt?.label||'Unbekannte Abteilung'}</div><div class="dim" style="font-size:11px;">Du bearbeitest die Bewertung fÃ¼r deine Abteilung</div></div></div></div>`;})();

  document.getElementById('bb-role').innerHTML=roleInfo;

  if(isAdmin){
    renderBBAdmin(bew);
  } else {
    renderBBAbteilung(bew,myAbt);
  }
}

function renderBBAdmin(bew){
  // Mittelwerte aus Abteilungen
  const avgData={};
  ALL_BB_ITEMS.forEach(item=>{
    const vals=ABTEILUNGEN.map(abt=>{
      const ab=bew[`abt_${abt.id}`]||{};
      return ab[item.k]||null;
    }).filter(v=>v!==null);
    if(vals.length){
      const gradeMap={A:4,B:3,C:2,D:1};
      const revMap={4:'A',3:'B',2:'C',1:'D'};
      const avg=vals.reduce((s,v)=>s+(gradeMap[v]||0),0)/vals.length;
      avgData[item.k]=revMap[Math.round(avg)]||null;
    }
  });

  let html='';
  // Abteilungs-Ãœbersicht
  html+=`<div class="card" style="margin-bottom:14px;"><div class="card-t">Abteilungsbewertungen (Ãœbersicht)</div>
    <div class="card-s">Bewertungen aller Abteilungsleiter Â· Klicke auf eine Abteilung zum Aufklappen</div>`;

  ABTEILUNGEN.forEach(abt=>{
    const ab=bew[`abt_${abt.id}`]||{};
    const hasData=ALL_BB_ITEMS.some(item=>ab[item.k]);
    html+=`<div class="abt-section">
      <div class="abt-hd" onclick="window.this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
        <span>${abt.icon} ${abt.label}</span>
        <span>${hasData?'<span class="tag tg">AusgefÃ¼llt</span>':'<span class="tag tr">Ausstehend</span>'}</span>
        <span class="chev">â–¶</span>
      </div>
      <div class="abt-body">`;

    Object.values(BB_KRITERIEN).forEach(dim=>{
      html+=`<div style="margin-bottom:8px;"><div style="font-size:11px;font-weight:600;color:${dim.color};margin-bottom:4px;">${dim.label}</div>`;
      dim.items.forEach(item=>{
        const val=ab[item.k]||'â€“';
        const comment=ab[item.k+'_c']||'';
        const cls=val==='A'?'tg':val==='B'?'tb':val==='C'?'ty':val==='D'?'tr':'';
        html+=`<div style="display:flex;align-items:flex-start;gap:8px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.04);">
          <div style="flex:1;font-size:11px;">${item.label}</div>
          <span class="tag ${cls}" style="min-width:12px;text-align:center;">${val}</span>
          ${comment?`<div class="dim" style="font-size:10px;font-style:italic;max-width:120px;">"${comment}"</div>`:''}
        </div>`;
      });
      html+=`</div>`;
    });

    // Selbstbeurteilung
    if(ab.selbst_betrieb||ab.selbst_bb){
      html+=`<div style="font-size:11px;margin-top:6px;padding:6px;background:rgba(255,255,255,.03);border-radius:6px;">`;
      if(ab.selbst_betrieb)html+=`<div class="dim">Betrieb: "${ab.selbst_betrieb}"</div>`;
      if(ab.selbst_bb)html+=`<div class="dim">Betreuung BB: "${ab.selbst_bb}"</div>`;
      html+=`</div>`;
    }
    html+=`</div></div>`;
  });
  html+=`</div>`;

  // Mittelwert-Anzeige
  html+=`<div class="card" style="margin-bottom:14px;"><div class="card-t">Mittelwerte (automatisch berechnet)</div>`;
  Object.values(BB_KRITERIEN).forEach(dim=>{
    html+=`<div style="margin-bottom:6px;"><div style="font-size:11px;color:${dim.color};font-weight:600;margin-bottom:3px;">${dim.label}</div>`;
    dim.items.forEach(item=>{
      const v=avgData[item.k]||'â€“';
      const cls=v==='A'?'tg':v==='B'?'tb':v==='C'?'ty':v==='D'?'tr':'';
      html+=`<div style="display:flex;justify-content:space-between;font-size:11px;padding:3px 0;">
        <span class="dim">${item.label}</span><span class="tag ${cls}">${v}</span></div>`;
    });
    html+=`</div>`;
  });
  html+=`</div>`;

  // Finale Bewertung
  html+=`<div class="card"><div class="card-t">Finale Beurteilung (Berufsbildner)</div>
    <div class="card-s">A = Ã¼bertroffen Â· B = erfÃ¼llt Â· C = knapp erfÃ¼llt Â· D = nicht erfÃ¼llt</div>`;
  const fin=bew.final||{};

  Object.values(BB_KRITERIEN).forEach(dim=>{
    html+=`<div style="margin-bottom:12px;"><div style="font-size:12px;font-weight:600;color:${dim.color};margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border);">${dim.label}</div>`;
    dim.items.forEach(item=>{
      const val=fin[item.k]||'';
      const comm=fin[item.k+'_c']||'';
      html+=`<div class="bb-item-row">
        <div style="flex:1;"><div style="font-size:12px;">${item.label}</div>
          ${item.desc?`<div class="dim" style="font-size:10px;">${item.desc}</div>`:''}
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end;min-width:160px;">
          <div class="abcd-btns">
            ${['A','B','C','D'].map(g=>`<button class="abcd-btn ${val===g?'sel-'+g:''}" onclick="window.setFinalGrade('${item.k}','${g}')">${g}</button>`).join('')}
          </div>
          <input type="text" class="fi" style="width:150px;font-size:10px;padding:4px 8px;" placeholder="Kommentarâ€¦" 
            value="${comm.replace(/"/g,'&quot;')}" 
            oninput="window.setFinalComment('${item.k}',this.value)">
        </div>
      </div>`;
    });
    html+=`</div>`;
  });

  // Ziele nÃ¤chstes Semester
  html+=`<div class="divider"></div>
    <div class="card-t" style="font-size:13px;">9. Ziele fÃ¼r das nÃ¤chste Semester</div>
    <label class="fl">Betriebliche Bildungsziele</label>
    <textarea class="fi" id="fin-ziel-betrieb" placeholder="Betriebliche Zieleâ€¦">${fin.ziel_betrieb||''}</textarea>
    <label class="fl">Fachkompetenz</label>
    <textarea class="fi" id="fin-ziel-fach" placeholder="Fachliche Zieleâ€¦">${fin.ziel_fach||''}</textarea>
    <label class="fl">Methodenkompetenz</label>
    <textarea class="fi" id="fin-ziel-meth" placeholder="Methodenzieleâ€¦">${fin.ziel_meth||''}</textarea>
    <label class="fl">Sozialkompetenz</label>
    <textarea class="fi" id="fin-ziel-soz" placeholder="Soziale Zieleâ€¦">${fin.ziel_soz||''}</textarea>
    <label class="fl">Selbstkompetenz</label>
    <textarea class="fi" id="fin-ziel-selbst" placeholder="PersÃ¶nliche Zieleâ€¦">${fin.ziel_selbst||''}</textarea>
    <label class="fl">Diverses / Abmachungen Freikurse</label>
    <textarea class="fi" id="fin-diverses" placeholder="Diversesâ€¦">${fin.diverses||''}</textarea>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn btn-gold" onclick="window.saveFinalBew()">ğŸ’¾ Finale Bewertung speichern</button>
      <button class="btn btn-out" onclick="window.generateBB()">ğŸ“‹ Bericht generieren</button>
    </div>
  </div>`;
  document.getElementById('bb-form').innerHTML=html;
}

function renderBBAbteilung(bew,abtId){
  const abt=ABTEILUNGEN.find(a=>a.id===abtId);
  const ab=bew[`abt_${abtId}`]||{};
  let html=`<div class="card"><div class="card-t">${abt?.icon||''} Beurteilung ${abt?.label||'Abteilung'}</div>
    <div class="card-s">A = Anforderungen Ã¼bertroffen Â· B = Anforderungen erfÃ¼llt Â· C = knapp erfÃ¼llt Â· D = nicht erfÃ¼llt</div>`;

  Object.values(BB_KRITERIEN).forEach(dim=>{
    html+=`<div style="margin-bottom:14px;"><div style="font-size:12px;font-weight:600;color:${dim.color};margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border);">${dim.label}</div>`;
    dim.items.forEach(item=>{
      const val=ab[item.k]||'';
      const comm=ab[item.k+'_c']||'';
      html+=`<div class="bb-item-row">
        <div style="flex:1;"><div style="font-size:12px;">${item.label}</div>
          ${item.desc?`<div class="dim" style="font-size:10px;">${item.desc}</div>`:''}
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end;min-width:160px;">
          <div class="abcd-btns">
            ${['A','B','C','D'].map(g=>`<button class="abcd-btn ${val===g?'sel-'+g:''}" onclick="window.setAbtGrade('${abtId}','${item.k}','${g}')">${g}</button>`).join('')}
          </div>
          <input type="text" class="fi" style="width:150px;font-size:10px;padding:4px 8px;" placeholder="Kommentarâ€¦"
            value="${comm.replace(/"/g,'&quot;')}"
            oninput="window.setAbtComment('${abtId}','${item.k}',this.value)">
        </div>
      </div>`;
    });
    html+=`</div>`;
  });

  // Selbstbeurteilung durch den Lernenden (kann von der Abteilung erfasst werden)
  html+=`<div class="divider"></div>
    <div style="font-size:12px;font-weight:600;margin-bottom:8px;">7. Beurteilung der Ausbildung durch die lernende Person</div>
    <div style="font-size:11px;color:var(--dim);margin-bottom:8px;">Die lernende Person beurteilt die erhaltene Ausbildung in dieser Abteilung:</div>
    <div class="bb-item-row" style="margin-bottom:8px;">
      <div style="flex:1;font-size:12px;">7.1 Erhaltene betriebliche Ausbildung (${abt?.label})</div>
      <div class="abcd-btns">
        ${['A','B','C','D'].map(g=>`<button class="abcd-btn ${(ab.selbst_betrieb||'')===(g)?'sel-'+g:''}" onclick="window.setAbtGrade('${abtId}','selbst_betrieb','${g}')">${g}</button>`).join('')}
      </div>
    </div>
    <label class="fl">BegrÃ¼ndung / ErgÃ¤nzungen Selbstbeurteilung</label>
    <textarea class="fi" id="abt-selbst-bem" placeholder="BegrÃ¼ndungen und ErgÃ¤nzungen der lernenden Personâ€¦">${ab.selbst_bem||''}</textarea>
    <div style="margin-top:12px;">
      <button class="btn btn-gold" onclick="window.saveAbtBew('${abtId}')">ğŸ’¾ Bewertung speichern</button>
    </div>
  </div>`;
  document.getElementById('bb-form').innerHTML=html;
}

function setAbtGrade(abtId,key,grade){
  if(!S.bewertungen[currentLid])S.bewertungen[currentLid]={};
  const akey=`abt_${abtId}`;
  if(!S.bewertungen[currentLid][akey])S.bewertungen[currentLid][akey]={};
  S.bewertungen[currentLid][akey][key]=grade;
  // Update button styles
  const btn=document.querySelector(`[onclick="window.setAbtGrade('${abtId}','${key}','${grade}')"]`);
  if(btn){
    btn.closest('.abcd-btns')?.querySelectorAll('.abcd-btn').forEach(b=>b.className='abcd-btn');
    btn.className=`abcd-btn sel-${grade}`;
  }
}
function setAbtComment(abtId,key,val){
  if(!S.bewertungen[currentLid])S.bewertungen[currentLid]={};
  const akey=`abt_${abtId}`;
  if(!S.bewertungen[currentLid][akey])S.bewertungen[currentLid][akey]={};
  S.bewertungen[currentLid][akey][key+'_c']=val;
}
async function saveAbtBew(abtId){
  // Auch selbst_bem
  const bemEl=document.getElementById('abt-selbst-bem');
  if(bemEl){
    const akey=`abt_${abtId}`;
    if(!S.bewertungen[currentLid])S.bewertungen[currentLid]={};
    if(!S.bewertungen[currentLid][akey])S.bewertungen[currentLid][akey]={};
    S.bewertungen[currentLid][akey].selbst_bem=bemEl.value;
  }
  await wj(`users/${uid()}/bewertungen/data`,S.bewertungen);
  toast('âœ“ Bewertung gespeichert');
}

function setFinalGrade(key,grade){
  if(!S.bewertungen[currentLid])S.bewertungen[currentLid]={};
  if(!S.bewertungen[currentLid].final)S.bewertungen[currentLid].final={};
  S.bewertungen[currentLid].final[key]=grade;
  const btn=document.querySelector(`[onclick="window.setFinalGrade('${key}','${grade}')"]`);
  if(btn){btn.closest('.abcd-btns')?.querySelectorAll('.abcd-btn').forEach(b=>b.className='abcd-btn');btn.className=`abcd-btn sel-${grade}`;}
}
function setFinalComment(key,val){
  if(!S.bewertungen[currentLid])S.bewertungen[currentLid]={};
  if(!S.bewertungen[currentLid].final)S.bewertungen[currentLid].final={};
  S.bewertungen[currentLid].final[key+'_c']=val;
}
async function saveFinalBew(){
  if(!S.bewertungen[currentLid])S.bewertungen[currentLid]={};
  if(!S.bewertungen[currentLid].final)S.bewertungen[currentLid].final={};
  const f=S.bewertungen[currentLid].final;
  ['ziel_betrieb','ziel_fach','ziel_meth','ziel_soz','ziel_selbst','diverses'].forEach(k=>{
    const el=document.getElementById('fin-'+k);if(el)f[k]=el.value;
  });
  await wj(`users/${uid()}/bewertungen/data`,S.bewertungen);
  toast('âœ“ Finale Bewertung gespeichert');
}
function generateBB(){
  const l=S.lehrlinge.find(x=>x.id===currentLid);if(!l)return;
  const bew=S.bewertungen[currentLid]||{},fin=bew.final||{};
  let html=`<div class="bb-prev">
    <div style="font-family:'DM Serif Display',serif;font-size:20px;">Bildungsbericht</div>
    <div class="dim" style="font-size:11px;margin-bottom:8px;">Hotel-KoFa EFZ Â· ${new Date().toLocaleDateString('de-CH')}</div>
    <div class="divider"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px;margin-bottom:8px;">
      <div><b>Lernende/r:</b> ${l.vorname} ${l.nachname}</div>
      <div><b>Lehrjahr:</b> ${l.lj}. Lehrjahr</div>
      <div><b>Lehrbetrieb:</b> Hotel & Gastro formation</div>
      <div><b>Ausbildungsstart:</b> ${l.start}</div>
    </div>
    <div style="font-size:10px;color:var(--dim);margin-bottom:10px;">A = Ã¼bertroffen Â· B = erfÃ¼llt Â· C = knapp erfÃ¼llt Â· D = nicht erfÃ¼llt</div>`;

  Object.values(BB_KRITERIEN).forEach(dim=>{
    html+=`<div style="margin-bottom:10px;"><div style="font-size:11px;font-weight:700;color:${dim.color};margin-bottom:4px;">${dim.label}</div>`;
    dim.items.forEach(item=>{
      const fv=fin[item.k]||'â€“';const fc=fin[item.k+'_c']||'';
      const cls=fv==='A'?'tg':fv==='B'?'tb':fv==='C'?'ty':fv==='D'?'tr':'';
      html+=`<div style="display:flex;gap:6px;font-size:11px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04);">
        <span style="flex:1;">${item.label}</span>
        <span class="tag ${cls}">${fv}</span>
        ${fc?`<span class="dim" style="font-size:10px;font-style:italic;">${fc}</span>`:''}
      </div>`;
    });
    html+=`</div>`;
  });

  if(fin.ziel_betrieb||fin.ziel_fach){
    html+=`<div class="divider"></div><div style="font-size:11px;font-weight:700;margin-bottom:6px;">Ziele fÃ¼r das nÃ¤chste Semester</div>`;
    if(fin.ziel_betrieb)html+=`<div style="font-size:11px;margin-bottom:4px;"><b>Betrieb:</b> ${fin.ziel_betrieb}</div>`;
    if(fin.ziel_fach)html+=`<div style="font-size:11px;margin-bottom:4px;"><b>Fach:</b> ${fin.ziel_fach}</div>`;
    if(fin.ziel_soz)html+=`<div style="font-size:11px;margin-bottom:4px;"><b>Sozial:</b> ${fin.ziel_soz}</div>`;
    if(fin.ziel_selbst)html+=`<div style="font-size:11px;margin-bottom:4px;"><b>Selbst:</b> ${fin.ziel_selbst}</div>`;
  }
  if(fin.diverses)html+=`<div class="divider"></div><div style="font-size:11px;"><b>Diverses:</b> ${fin.diverses}</div>`;

  html+=`<div class="divider" style="margin-top:20px;"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;font-size:11px;color:var(--dim);margin-top:6px;">
      <div>Berufsbildner/in:<br><br>_________________________</div>
      <div>Lernende Person:<br><br>_________________________</div>
      <div>Datum: _________________</div>
      <div>Gesetzl. Vertreter/in:<br><br>_________________________</div>
    </div>
    <div class="dim" style="font-size:9px;margin-top:8px;">Â© SDBB Â· Bildungsplan Hotel-KoFa EFZ Â· Berufsnummer 79200</div>
  </div>`;
  document.getElementById('bb-preview').innerHTML=html;
  toast('âœ“ Bildungsbericht generiert');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QV VORBEREITUNG (mit eigenen Aufgaben / Szenarien)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getAllSzenarien(){
  return [...QV_SZENARIEN_DEFAULT,...S.szenarien];
}
function renderQV(){
  makeLB('qv-lb');
  if(!currentLid)return;
  const hkSt=calcHKStatus(currentLid);
  const lzP=calcLZProg(currentLid);
  const days=Math.max(0,Math.ceil((new Date(S.einstellungen.qvDatum||'2026-07-01')-new Date())/86400000));
  document.getElementById('qv-days').textContent=days;
  document.getElementById('qv-lz-bar').style.width=lzP.pct+'%';
  document.getElementById('qv-lz-pct').textContent=lzP.pct+'%';

  // HKB Bereitschaft
  let hkbHtml='';
  BP.forEach(hkb=>{
    const ids=hkb.kompetenzen.map(k=>k.id);
    const done=ids.filter(id=>hkSt[id]===2).length;
    const ac=done/ids.length>=.8?'g':done/ids.length>=.5?'y':'r';
    hkbHtml+=`<div class="qv-block" style="border-left:3px solid ${hkb.color}">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
        <div class="amp ${ac}"></div>
        <div style="font-size:12px;font-weight:600;flex:1;">${hkb.code}: ${hkb.titel}</div>
        <span class="tag ${ac==='g'?'tg':ac==='y'?'ty':'tr'}">${done}/${ids.length} HK</span>
      </div>
      ${hkb.kompetenzen.map(hk=>{const s=hkSt[hk.id]||0;const ac2=s===2?'g':s===1?'y':'r';return`
        <div style="display:flex;align-items:center;gap:7px;padding:3px 8px;">
          <div class="amp ${ac2}" style="width:7px;height:7px;"></div>
          <span class="dim" style="font-size:11px;flex:1;">HK ${hk.id}: ${hk.titel}</span>
          <span class="tag ${ac2==='g'?'tg':ac2==='y'?'ty':'tr'}" style="font-size:9px;">${ac2==='g'?'âœ“':ac2==='y'?'Teil.':'Offen'}</span>
        </div>`}).join('')}
    </div>`;
  });
  document.getElementById('qv-hkb').innerHTML=hkbHtml;

  // Szenarien
  renderQVSzenarien();
}

function renderQVSzenarien(){
  const bew=S.bewertungen[currentLid]||{};
  const allSz=getAllSzenarien();
  let html='';
  allSz.forEach(sz=>{
    const done=(bew[`sz_${sz.id}`]||[]);
    const allDone=done.length===sz.aufgaben.length;
    const isCustom=!!sz._ts||S.szenarien.find(s=>s.id===sz.id);
    html+=`<div class="qv-sz-card">
      <div class="qv-sz-hd">
        <div style="flex:1;"><div style="font-size:13px;font-weight:600;">${sz.titel}</div>
          <div class="dim" style="font-size:11px;margin-top:2px;">${sz.beschreibung||''}</div>
        </div>
        <div style="display:flex;gap:5px;align-items:center;">
          <span class="tag ${allDone?'tg':done.length>0?'ty':'tr'}">${done.length}/${sz.aufgaben.length}</span>
          ${isCustom?`<button class="btn btn-sm" style="background:transparent;border:1px solid var(--red);color:var(--red-l);" onclick="window.deleteSzenario('${sz.id}')">ğŸ—‘</button>`:''}
        </div>
      </div>
      <div style="margin-top:8px;">
        ${sz.aufgaben.map((a,i)=>{
          const text=typeof a==='string'?a:a.text;
          const isDone=done.includes(i);
          return `<div class="lz-row" onclick="window.toggleSzAufgabe('${sz.id}',${i},this)">
            <div class="lz-cb ${isDone?'on':''}">${isDone?'âœ“':''}</div>
            <div class="lz-t ${isDone?'done-t':''}">${text}</div>
          </div>`;
        }).join('')}
      </div>
      <button class="btn btn-out btn-sm" style="margin-top:8px;" onclick="window.openAddAufgabe('${sz.id}')">+ Aufgabe hinzufÃ¼gen</button>
    </div>`;
  });
  html+=`<button class="btn btn-gold" style="width:100%;margin-top:8px;" onclick="window.openModal('szenario')">+ Neues Szenario erstellen</button>`;
  document.getElementById('qv-szenarien').innerHTML=html;
}

function openAddAufgabe(szId){
  document.getElementById('add-aufgabe-sz-id').value=szId;
  document.getElementById('add-aufgabe-text').value='';
  openModal('aufgabe');
}
async function saveAufgabe(){
  const szId=document.getElementById('add-aufgabe-sz-id').value;
  const text=document.getElementById('add-aufgabe-text').value.trim();
  if(!text){toast('Bitte Aufgabentext eingeben','red');return;}
  // Finde Szenario
  const customSz=S.szenarien.find(s=>s.id===szId);
  const defaultSz=QV_SZENARIEN_DEFAULT.find(s=>s.id===szId);
  if(customSz){
    if(!customSz.aufgaben)customSz.aufgaben=[];
    customSz.aufgaben.push(text);
    await upd(`users/${uid()}/szenarien/${customSz.id}`,{aufgaben:customSz.aufgaben});
  } else if(defaultSz){
    // Clone als custom
    const newSz={...defaultSz,id:'custom_'+Date.now(),aufgaben:[...defaultSz.aufgaben,text],_custom:true};
    // Ersetze Default-Referenzen mit dem Original + neue Aufgabe
    // Einfacher: direkt als neues Szenario mit modifiziertem Inhalt
    const id=await add(`users/${uid()}/szenarien`,{...newSz});
    S.szenarien.push({id,...newSz});
    toast('Aufgabe zu neuem Custom-Szenario hinzugefÃ¼gt');
    closeModal('aufgabe');renderQVSzenarien();return;
  }
  toast('âœ“ Aufgabe hinzugefÃ¼gt');
  closeModal('aufgabe');renderQVSzenarien();
}
async function saveSzenario(){
  const titel=document.getElementById('sz-titel').value.trim();
  const beschr=document.getElementById('sz-beschr').value.trim();
  const aufgabenText=document.getElementById('sz-aufgaben').value.trim();
  if(!titel){toast('Bitte Titel eingeben','red');return;}
  const aufgaben=aufgabenText.split('\n').map(s=>s.trim()).filter(s=>s.length>0);
  const data={id:'cust_'+Date.now(),titel,beschreibung:beschr,aufgaben,hkbs:[]};
  showLoading(true);
  const id=await add(`users/${uid()}/szenarien`,data);
  S.szenarien.push({id,...data});
  showLoading(false);closeModal('szenario');toast('âœ“ Szenario erstellt');renderQVSzenarien();
}
async function deleteSzenario(szId){
  if(!confirm('Szenario lÃ¶schen?'))return;
  const sz=S.szenarien.find(s=>s.id===szId);
  if(sz){await del(`users/${uid()}/szenarien/${sz.id}`);}
  S.szenarien=S.szenarien.filter(s=>s.id!==szId);
  toast('Szenario gelÃ¶scht');renderQVSzenarien();
}
async function toggleSzAufgabe(szId,idx,rowEl){
  if(!S.bewertungen[currentLid])S.bewertungen[currentLid]={};
  const key=`sz_${szId}`;
  const arr=S.bewertungen[currentLid][key]||[];
  const pos=arr.indexOf(idx);
  if(pos>-1)arr.splice(pos,1);else arr.push(idx);
  S.bewertungen[currentLid][key]=arr;
  const cb=rowEl.querySelector('.lz-cb'),txt=rowEl.querySelector('.lz-t');
  const isDone=arr.includes(idx);
  cb.classList.toggle('on',isDone);cb.textContent=isDone?'âœ“':'';txt.classList.toggle('done-t',isDone);
  const sz=getAllSzenarien().find(s=>s.id===szId);
  const card=rowEl.closest('.qv-sz-card');
  const ctr=card?.querySelector('.tag');
  if(ctr&&sz){ctr.textContent=`${arr.length}/${sz.aufgaben.length}`;ctr.className=`tag ${arr.length===sz.aufgaben.length?'tg':arr.length>0?'ty':'tr'}`;}
  await wj(`users/${uid()}/bewertungen/data`,S.bewertungen);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EINSATZPLAN (Monat / Woche / Tag)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ABTS=[
  {k:'empfang',l:'Empfang',cls:'ae',icon:'ğŸ›ï¸'},
  {k:'reservierung',l:'Reservierung',cls:'ar',icon:'ğŸ“'},
  {k:'kommunikation',l:'Kommunikation',cls:'ak',icon:'ğŸ’¬'},
  {k:'service',l:'Service/F&B',cls:'as',icon:'ğŸ½ï¸'},
  {k:'housekeeping',l:'Housekeeping',cls:'ah',icon:'ğŸ›ï¸'},
  {k:'administration',l:'Administration',cls:'aa',icon:'ğŸ’¼'},
  {k:'kueche',l:'KÃ¼che',cls:'ac',icon:'ğŸ³'},
  {k:'schule',l:'Schule/ÃœK',cls:'af',icon:'ğŸ«'},
  {k:'frei',l:'Frei/Ferien',cls:'af2',icon:'ğŸŒ¿'}
];
const MONTHS_DE=['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
const WDAYS_S=['Mo','Di','Mi','Do','Fr','Sa','So'];

function getKW(d){const t=new Date(d);t.setHours(0,0,0,0);t.setDate(t.getDate()+3-(t.getDay()+6)%7);const w1=new Date(t.getFullYear(),0,4);return 1+Math.round(((t-w1)/86400000-3+(w1.getDay()+6)%7)/7);}
function getMon(off=0){const now=new Date();const m=new Date(now);m.setDate(now.getDate()-((now.getDay()||7)-1)+off*7);m.setHours(0,0,0,0);return m;}
function dk(d){return d.toISOString().slice(0,10);}
function getSlot(lid,date){return(S.einsatzplan[lid]||{})[date]||null;}
function setSlot(lid,date,k){if(!S.einsatzplan[lid])S.einsatzplan[lid]={};S.einsatzplan[lid][date]=k;}

function changeEp(dir){
  if(epView==='month')epMonthOff+=dir;
  else if(epView==='week')epWeekOff+=dir;
  else epDayOff+=dir;
  renderEinsatz();
}
function resetEp(){
  if(epView==='month')epMonthOff=0;
  else if(epView==='week')epWeekOff=0;
  else epDayOff=0;
  renderEinsatz();
}
function setEpView(v){epView=v;document.querySelectorAll('.ep-view-btn').forEach(b=>b.classList.remove('active'));document.getElementById('epv-'+v)?.classList.add('active');}

function renderEinsatz(){
  // Update view buttons without recursion
  document.querySelectorAll('.ep-view-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('epv-'+epView)?.classList.add('active');
  if(epView==='month')renderEinsatzMonth();
  else if(epView==='week')renderEinsatzWeek();
  else renderEinsatzDay();
  renderEpPalette();
}

function renderEinsatzMonth(){
  const now=new Date();
  const baseMonth=new Date(now.getFullYear(),now.getMonth()+epMonthOff,1);
  document.getElementById('ep-label').textContent=`${MONTHS_DE[baseMonth.getMonth()]} ${baseMonth.getFullYear()}`;
  if(!currentLid){document.getElementById('ep-main').innerHTML='<div class="dim" style="padding:20px;text-align:center;">Bitte Lernende/n auswÃ¤hlen</div>';return;}
  const lid=currentLid;
  const l=S.lehrlinge.find(x=>x.id===lid);

  // Monats-Kalender
  const firstDay=new Date(baseMonth.getFullYear(),baseMonth.getMonth(),1);
  const lastDay=new Date(baseMonth.getFullYear(),baseMonth.getMonth()+1,0);
  // Start auf Montag
  let start=new Date(firstDay);
  const dow=(firstDay.getDay()||7)-1;
  start.setDate(start.getDate()-dow);

  let html=`<div class="ep-month-grid">`;
  // Header
  WDAYS_S.forEach(d=>html+=`<div class="ep-m-h">${d}</div>`);
  // Tage
  let cur=new Date(start);
  while(cur<=lastDay||cur.getDay()!==1){
    const d=dk(cur);
    const isCurrentMonth=cur.getMonth()===baseMonth.getMonth();
    const isToday=dk(cur)===dk(new Date());
    const abtKey=getSlot(lid,d)||null;
    const abt=ABTS.find(a=>a.k===abtKey);
    html+=`<div class="ep-m-cell ${isCurrentMonth?'':'other-month'} ${isToday?'today':''} ${abt?abt.cls:''}"
      onclick="window.epMonthClick('${lid}','${d}',this)"
      title="${cur.toLocaleDateString('de-CH',{weekday:'short',day:'numeric',month:'short'})}">
      <div class="ep-m-day">${cur.getDate()}</div>
      ${abt?`<div class="ep-m-abt">${abt.icon} ${abt.l}</div>`:'<div class="ep-m-abt-empty"></div>'}
    </div>`;
    cur.setDate(cur.getDate()+1);
    if(cur>lastDay&&cur.getDay()===1)break;
  }
  html+=`</div>`;
  // Lernenden-Auswahl fÃ¼r Monat
  if(S.lehrlinge.length>1){
    html=`<div class="lb" style="margin-bottom:12px;">${S.lehrlinge.map(l2=>`<div class="lp ${l2.id===lid?'active':''}" onclick="window.selectL('${l2.id}')"><div class="lav" style="background:${l2.color||'#555'}">${l2.initials}</div><div style="font-size:11px;">${l2.vorname}</div></div>`).join('')}</div>`+html;
  }
  document.getElementById('ep-main').innerHTML=html;
}

function renderEinsatzWeek(){
  const mon=getMon(epWeekOff);
  const fri=new Date(mon.getTime()+6*86400000);
  document.getElementById('ep-label').textContent=`KW ${getKW(mon)} Â· ${mon.toLocaleDateString('de-CH',{day:'2-digit',month:'2-digit'})} â€“ ${fri.toLocaleDateString('de-CH',{day:'2-digit',month:'2-digit',year:'numeric'})}`;
  const cols=S.lehrlinge.length||1;
  let html=`<div class="ep-grid" style="grid-template-columns:80px repeat(${cols},1fr)">`;
  html+='<div class="ep-h"></div>'+S.lehrlinge.map(l=>`<div class="ep-h">${l.vorname}<br><span class="dim" style="font-size:10px;">${l.lj}. LJ</span></div>`).join('');
  for(let di=0;di<7;di++){
    const d=new Date(mon.getTime()+di*86400000);
    const dkey=dk(d);
    const isToday=dkey===dk(new Date());
    html+=`<div class="ep-day" style="${isToday?'color:var(--gold);font-weight:600;':''}">${WDAYS_S[di]}<br><span style="font-size:10px;">${d.toLocaleDateString('de-CH',{day:'numeric',month:'numeric'})}</span></div>`;
    S.lehrlinge.forEach(l=>{
      const abtKey=getSlot(l.id,dkey)||'frei';
      const abt=ABTS.find(a=>a.k===abtKey)||ABTS[ABTS.length-1];
      html+=`<div class="ep-cell ${abt.cls} ${epSelectedCell?.lid===l.id&&epSelectedCell?.date===dkey?'selected':''}"
        onclick="window.epCellClick('${l.id}','${dkey}',this)">${abt.icon} ${abt.l}</div>`;
    });
  }
  html+=`</div>`;
  document.getElementById('ep-main').innerHTML=html;
}

function renderEinsatzDay(){
  const now=new Date();const d=new Date(now.setDate(now.getDate()+epDayOff));
  const dkey=dk(d);
  document.getElementById('ep-label').textContent=d.toLocaleDateString('de-CH',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  let html=`<div class="ep-day-grid">`;
  S.lehrlinge.forEach(l=>{
    const abtKey=getSlot(l.id,dkey)||null;
    const abt=ABTS.find(a=>a.k===abtKey);
    html+=`<div class="ep-day-card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
        <div class="lav" style="background:${l.color||'#555'}">${l.initials}</div>
        <div><div style="font-size:13px;font-weight:500;">${l.vorname} ${l.nachname}</div><div class="dim" style="font-size:10px;">${l.lj}. Lehrjahr</div></div>
      </div>
      <div class="ep-cell ${abt?abt.cls:'af2'}" style="width:100%;padding:10px;font-size:13px;margin-bottom:8px;">${abt?abt.icon+' '+abt.l:'â€” Nicht geplant'}</div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;">
        ${ABTS.map(a=>`<div class="ep-mini-btn ${a.cls}" onclick="window.setDaySlot('${l.id}','${dkey}','${a.k}')">${a.icon} ${a.l}</div>`).join('')}
      </div>
    </div>`;
  });
  html+=`</div>`;
  document.getElementById('ep-main').innerHTML=html;
}

function renderEpPalette(){
  document.getElementById('ep-palette').innerHTML=`
    <div class="dim" style="font-size:11px;margin-bottom:5px;">${epView==='month'?'Klicke auf einen Tag zum Planen':'Klicke auf Zelle, dann Abteilung wÃ¤hlen'}:</div>
    <div style="display:flex;flex-wrap:wrap;gap:4px;" id="ep-pal-btns">
      ${ABTS.map(a=>`<div class="ep-mini-btn ${a.cls}" id="pal-${a.k}"
        draggable="true"
        ondragstart="window.palDragStart(event,'${a.k}')">${a.icon} ${a.l}</div>`).join('')}
    </div>`;
}

let epMonthSelectedDate=null, epMonthSelectedLid=null, epMonthSelectedEl=null;
function epMonthClick(lid,date,el){
  // Deselektiere vorherigen
  document.querySelectorAll('.ep-m-cell.ep-selected').forEach(c=>c.classList.remove('ep-selected'));
  if(epMonthSelectedDate===date&&epMonthSelectedLid===lid){epMonthSelectedDate=null;epMonthSelectedLid=null;return;}
  el.classList.add('ep-selected');
  epMonthSelectedDate=date;epMonthSelectedLid=lid;
  // Palette-Buttons verdrahten
  document.querySelectorAll('[id^="pal-"]').forEach(btn=>{
    const k=btn.id.replace('pal-','');
    btn.onclick=()=>setMonthSlot(lid,date,k,el);
  });
}
async function setMonthSlot(lid,date,abtKey,cellEl){
  setSlot(lid,date,abtKey);
  await wj(`users/${uid()}/einsatzplan/data`,S.einsatzplan);
  if(cellEl){
    const abt=ABTS.find(a=>a.k===abtKey)||ABTS[ABTS.length-1];
    cellEl.className=`ep-m-cell ${abt.cls}`;
    const dayNum=cellEl.querySelector('.ep-m-day');
    cellEl.innerHTML='';
    const div1=document.createElement('div');div1.className='ep-m-day';div1.textContent=dayNum?.textContent||'';
    const div2=document.createElement('div');div2.className='ep-m-abt';div2.textContent=`${abt.icon} ${abt.l}`;
    cellEl.appendChild(div1);cellEl.appendChild(div2);
    cellEl.onclick=()=>{};
  }
  epMonthSelectedDate=null;epMonthSelectedLid=null;
  // Re-wire palette
  document.querySelectorAll('[id^="pal-"]').forEach(btn=>{btn.onclick=null;});
  toast('âœ“ Eingetragen');
}

function epCellClick(lid,date,el){
  document.querySelectorAll('.ep-cell.selected').forEach(c=>c.classList.remove('selected'));
  if(epSelectedCell?.lid===lid&&epSelectedCell?.date===date){epSelectedCell=null;return;}
  el.classList.add('selected');epSelectedCell={lid,date,el};
  document.querySelectorAll('[id^="pal-"]').forEach(btn=>{
    const k=btn.id.replace('pal-','');
    btn.onclick=()=>setWeekSlot(lid,date,k,el);
  });
}
async function setWeekSlot(lid,date,abtKey,cellEl){
  setSlot(lid,date,abtKey);
  await wj(`users/${uid()}/einsatzplan/data`,S.einsatzplan);
  const abt=ABTS.find(a=>a.k===abtKey)||ABTS[ABTS.length-1];
  if(cellEl){cellEl.className=`ep-cell ${abt.cls}`;cellEl.innerHTML=`${abt.icon} ${abt.l}`;cellEl.classList.remove('selected');}
  epSelectedCell=null;
  document.querySelectorAll('[id^="pal-"]').forEach(btn=>{btn.onclick=null;});
  toast('âœ“ Eingetragen');
}
async function setDaySlot(lid,date,abtKey){
  setSlot(lid,date,abtKey);
  await wj(`users/${uid()}/einsatzplan/data`,S.einsatzplan);
  renderEinsatzDay();toast('âœ“ Eingetragen');
}
function palDragStart(e,k){e.dataTransfer.setData('abt',k);}
function epDragOver(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function epDragLeave(e){e.currentTarget.classList.remove('drag-over');}
async function epDrop(e,lid,date){
  e.preventDefault();e.currentTarget.classList.remove('drag-over');
  const k=e.dataTransfer.getData('abt');if(!k)return;
  await setWeekSlot(lid,date,k,e.currentTarget);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TERMINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTermine(){
  makeLB('tm-lb');
  if(!currentLid)return;
  const now=new Date().toISOString().slice(0,10);
  const mine=S.termine.filter(t=>t.lid===currentLid).sort((a,b)=>a.datum.localeCompare(b.datum));
  const up=mine.filter(t=>t.datum>=now),past=mine.filter(t=>t.datum<now);
  let html='';
  if(!up.length&&!past.length){html='<div style="text-align:center;padding:24px;color:var(--dim);font-size:13px;">ğŸ“… Noch keine Termine.<br>Klicke Â«+ TerminÂ» um einen hinzuzufÃ¼gen.</div>';}
  if(up.length){html+=`<div class="tm-group-lbl">Bevorstehend</div>`;up.forEach(t=>{html+=termCard(t,false);});}
  if(past.length){html+=`<div class="tm-group-lbl" style="margin-top:14px;">Vergangen</div>`;past.forEach(t=>{html+=termCard(t,true);});}
  document.getElementById('tm-list').innerHTML=html;
}
function termCard(t,past){
  const ti={lernbericht:'ğŸ“',lernziel:'ğŸ“š',meeting:'ğŸ¤',pruefung:'ğŸ¯',sonstiges:'ğŸ“Œ'}[t.typ]||'ğŸ“Œ';
  const tl={lernbericht:'Lernbericht',lernziel:'Lernziel',meeting:'GesprÃ¤ch',pruefung:'PrÃ¼fung',sonstiges:'Sonstiges'}[t.typ]||'Termin';
  const dl=Math.ceil((new Date(t.datum)-new Date())/86400000);
  const urg=!past&&dl<=7?'tr':!past&&dl<=30?'ty':'tg';
  return`<div class="tm-card ${past?'past':''}">
    <div class="tm-date">${ti}<div>${fmtDate(t.datum)}</div><div class="dim" style="font-size:10px;">${past?'Verg.':dl===0?'Heute':dl===1?'Morgen':'in '+dl+' T.'}</div></div>
    <div class="tm-body">
      <div style="display:flex;align-items:center;gap:5px;margin-bottom:2px;">
        <span style="font-size:13px;font-weight:600;">${t.titel}</span>
        <span class="tag ${urg}">${tl}</span>
        ${t.erledigt?'<span class="tag tg">âœ“</span>':''}
      </div>
      ${t.beschreibung?`<div class="dim" style="font-size:12px;">${t.beschreibung}</div>`:''}
    </div>
    <div style="display:flex;gap:4px;flex-shrink:0;">
      ${!t.erledigt?`<button class="btn btn-out btn-sm" onclick="window.erledigeTermin('${t.id}')">âœ“</button>`:''}
      <button class="btn btn-out btn-sm" onclick="window.editTermin('${t.id}')">âœï¸</button>
      <button class="btn btn-sm" style="background:transparent;border:1px solid var(--red);color:var(--red-l);" onclick="window.deleteTermin('${t.id}')">ğŸ—‘</button>
    </div>
  </div>`;
}
function openNewTermin(){
  document.getElementById('tm-edit-id').value='';
  document.getElementById('tm-modal-title').textContent='Neuer Termin';
  ['tm-titel','tm-beschr'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('tm-datum').value=new Date().toISOString().slice(0,10);
  document.getElementById('tm-typ').value='lernbericht';
  if(currentLid)document.getElementById('tm-lid').value=currentLid;
  openModal('termin');
}
function editTermin(tid){
  const t=S.termine.find(x=>x.id===tid);if(!t)return;
  document.getElementById('tm-edit-id').value=tid;
  document.getElementById('tm-modal-title').textContent='Termin bearbeiten';
  document.getElementById('tm-lid').value=t.lid;
  document.getElementById('tm-titel').value=t.titel;
  document.getElementById('tm-datum').value=t.datum;
  document.getElementById('tm-typ').value=t.typ||'sonstiges';
  document.getElementById('tm-beschr').value=t.beschreibung||'';
  openModal('termin');
}
async function saveTermin(){
  const eid=document.getElementById('tm-edit-id').value;
  const data={lid:document.getElementById('tm-lid').value,titel:document.getElementById('tm-titel').value.trim(),
    datum:document.getElementById('tm-datum').value,typ:document.getElementById('tm-typ').value,
    beschreibung:document.getElementById('tm-beschr').value,erledigt:false};
  if(!data.titel||!data.datum){toast('Titel und Datum eingeben','red');return;}
  showLoading(true);
  if(eid){await upd(`users/${uid()}/termine/${eid}`,data);const idx=S.termine.findIndex(x=>x.id===eid);if(idx>-1)S.termine[idx]={...S.termine[idx],...data};toast('âœ“ Termin aktualisiert');}
  else{const id=await add(`users/${uid()}/termine`,data);S.termine.push({id,...data});toast('âœ“ Termin gespeichert');}
  showLoading(false);closeModal('termin');renderTermine();
}
async function erledigeTermin(tid){
  await upd(`users/${uid()}/termine/${tid}`,{erledigt:true});
  const t=S.termine.find(x=>x.id===tid);if(t)t.erledigt=true;
  toast('âœ“ Erledigt');renderTermine();
}
async function deleteTermin(tid){
  if(!confirm('Termin lÃ¶schen?'))return;
  await del(`users/${uid()}/termine/${tid}`);
  S.termine=S.termine.filter(x=>x.id!==tid);
  toast('Termin gelÃ¶scht');renderTermine();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BENUTZER & ROLLEN (nur Admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBenutzer(){
  let html=`<div class="card" style="margin-bottom:14px;">
    <div class="card-t">Benutzer verwalten</div>
    <div class="card-s">Weise anderen Benutzern eine Abteilungsrolle zu. Die E-Mail muss zuerst registriert sein.</div>
    <div id="benutzer-list">`;

  if(!S.benutzer.length){
    html+=`<div class="dim" style="padding:12px;text-align:center;">Noch keine Rollen vergeben.<br>Der erste registrierte Benutzer ist automatisch Admin.</div>`;
  } else {
    S.benutzer.forEach(b=>{
      const abt=ABTEILUNGEN.find(a=>a.id===b.abteilung);
      html+=`<div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);">
        <div style="flex:1;"><div style="font-size:12px;font-weight:500;">${b.email}</div>
          <div class="dim" style="font-size:10px;">${b.role==='admin'?'ğŸ‘¤ Admin':abt?abt.icon+' '+abt.label:'Keine Rolle'}</div>
        </div>
        <button class="btn btn-out btn-sm" onclick="window.deleteBenutzer('${b.id}')">ğŸ—‘</button>
      </div>`;
    });
  }
  html+=`</div></div>`;

  html+=`<div class="card">
    <div class="card-t">Rolle vergeben</div>
    <div class="card-s">Gib die E-Mail-Adresse des Benutzers ein und wÃ¤hle eine Rolle</div>
    <label class="fl">E-Mail des Benutzers</label>
    <input class="fi" type="email" id="ben-email" placeholder="abteilungsleiter@hotel.ch">
    <label class="fl">Rolle / Abteilung</label>
    <select class="fi" id="ben-role">
      <option value="admin">ğŸ‘¤ Admin (Berufsbildner)</option>
      ${ABTEILUNGEN.map(a=>`<option value="${a.id}">${a.icon} ${a.label}</option>`).join('')}
    </select>
    <button class="btn btn-gold" style="margin-top:12px;" onclick="window.saveBenutzer()">âœ“ Rolle speichern</button>
  </div>`;

  document.getElementById('benutzer-content').innerHTML=html;
}

async function saveBenutzer(){
  const email=document.getElementById('ben-email').value.trim();
  const role=document.getElementById('ben-role').value;
  if(!email){toast('E-Mail eingeben','red');return;}
  const isAbt=ABTEILUNGEN.some(a=>a.id===role);
  const data={email,role:isAbt?'abt':'admin',abteilung:isAbt?role:null};
  showLoading(true);
  const id=await add(`users/${uid()}/benutzer`,data);
  // Auch im globalen profiles Pfad speichern damit der User seine eigene Rolle laden kann
  // (vereinfacht: wir suchen via email)
  await wj(`emailRoles/${email.replace(/\./g,'_').replace(/@/g,'_at_')}`,{...data,adminUid:uid()});
  S.benutzer.push({id,...data});
  showLoading(false);toast('âœ“ Rolle gespeichert');renderBenutzer();
}
async function deleteBenutzer(bid){
  await del(`users/${uid()}/benutzer/${bid}`);
  S.benutzer=S.benutzer.filter(x=>x.id!==bid);
  toast('Rolle gelÃ¶scht');renderBenutzer();
}

// Lade eigene Rolle beim Login
async function loadMyRole(){
  const emailKey=user.email.replace(/\./g,'_').replace(/@/g,'_at_');
  const snap=await rj(`emailRoles/${emailKey}`);
  if(snap){
    userProfile={role:snap.role,abteilung:snap.abteilung};
  } else {
    userProfile={role:'admin',abteilung:null};
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KI ASSISTENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const KI_SYS=`Du bist ein erfahrener Berufsbildungsexperte fÃ¼r Hotel-Kommunikationsfachfrau/-mann EFZ (Berufsnummer 79200). Du kennst den Bildungsplan von Hotel & Gastro formation (2017) mit allen 4 HKBs, 21 Handlungskompetenzen (HK 1.1â€“4.4) und allen Leistungszielen. Das QV besteht aus CPEX (3 Situationen) und PEX (FachgesprÃ¤ch). Antworte auf Deutsch, praxisnah fÃ¼r Berufsbildner/innen in Hotelbetrieben.`;
async function saveApiKey(){
  const k=document.getElementById('ki-key').value.trim();
  S.einstellungen.apiKey=k;
  await wj(`users/${uid()}/einstellungen/data`,S.einstellungen);
  document.getElementById('ki-status').innerHTML=k.startsWith('sk-ant-')?'<span style="color:var(--green-l)">âœ“</span>':'<span style="color:var(--yellow)">âš </span>';
}
function qAsk(t){document.getElementById('ki-in').value=t;kiSend();}
function kiKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();kiSend();}}
function kiResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function addMsg(role,html,id){
  const msgs=document.getElementById('ki-msgs');
  const div=document.createElement('div');div.className='ki-msg '+role;div.innerHTML=html;
  if(id)div.id=id;msgs.appendChild(div);msgs.scrollTop=msgs.scrollHeight;
}
async function kiSend(){
  const el=document.getElementById('ki-in'),text=el.value.trim();if(!text)return;
  const key=S.einstellungen.apiKey||document.getElementById('ki-key').value.trim();
  if(!key.startsWith('sk-ant-')){addMsg('assistant','âš ï¸ Bitte erst API-Key eingeben.');return;}
  addMsg('user',text);el.value='';el.style.height='auto';
  kiHistory.push({role:'user',content:text});
  const tid='ki'+Date.now();addMsg('assistant','<span style="opacity:.5">â—â—â—</span>',tid);
  try{
    const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1500,system:KI_SYS,messages:kiHistory})});
    const d=await r.json();
    const reply=d.content?.[0]?.text||d.error?.message||'Fehler';
    kiHistory.push({role:'assistant',content:reply});
    document.getElementById(tid)?.remove();
    addMsg('assistant',reply.replace(/\n/g,'<br>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>'));
  }catch(e){document.getElementById(tid)?.remove();addMsg('assistant','âŒ '+e.message);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEHRLINGE & DATENBANK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addLehrling(){
  const vn=document.getElementById('nl-vn').value.trim(),nn=document.getElementById('nl-nn').value.trim();
  if(!vn||!nn){toast('Vor- und Nachname eingeben','red');return;}
  const colors=['#C9A84C','#3A6FA0','#5B8C5A','#9B5E8C','#C8675A','#4A8080'];
  const color=colors[S.lehrlinge.length%colors.length];
  const data={vorname:vn,nachname:nn,lj:parseInt(document.getElementById('nl-lj').value),
    start:document.getElementById('nl-start').value,initials:(vn[0]+(nn[0]||'')).toUpperCase(),color};
  showLoading(true);const id=await add(`users/${uid()}/lehrlinge`,data);
  S.lehrlinge.push({id,...data});currentLid=id;
  showLoading(false);closeModal('lehrling');toast('âœ“ Lehrling hinzugefÃ¼gt');renderAll();fillDropdowns();
}
async function deleteLehrling(lid){
  if(!confirm('Lehrling und alle Daten lÃ¶schen?'))return;
  showLoading(true);await del(`users/${uid()}/lehrlinge/${lid}`);
  S.lehrlinge=S.lehrlinge.filter(x=>x.id!==lid);
  if(currentLid===lid)currentLid=S.lehrlinge[0]?.id||null;
  showLoading(false);renderAll();toast('Lehrling gelÃ¶scht');
}
function renderDB(){
  const lzP=S.lehrlinge.reduce((acc,l)=>{const p=calcLZProg(l.id);return{done:acc.done+p.done,total:acc.total+p.total};},{done:0,total:0});
  document.getElementById('db-status').innerHTML=`
    <div class="sr">Lehrlinge<span>${S.lehrlinge.length}</span></div>
    <div class="sr">Lernberichte<span>${S.lernberichte.length}</span></div>
    <div class="sr">Visiert<span>${S.lernberichte.filter(b=>b.status==='visiert').length}</span></div>
    <div class="sr">LZ erledigt<span>${lzP.done}/${lzP.total}</span></div>
    <div class="sr">Termine<span>${S.termine.length}</span></div>
    <div class="sr">Szenarien (Custom)<span>${S.szenarien.length}</span></div>
    <div class="sr">Benutzer/Rollen<span>${S.benutzer.length}</span></div>`;
  document.getElementById('db-lehrlinge').innerHTML=S.lehrlinge.length===0
    ?'<div class="dim" style="font-size:12px;text-align:center;padding:12px;">Noch keine Lernenden.</div>'
    :S.lehrlinge.map(l=>`<div style="display:flex;align-items:center;gap:9px;padding:8px 0;border-bottom:1px solid var(--border);">
        <div class="lav" style="background:${l.color||'#555'}">${l.initials}</div>
        <div style="flex:1;font-size:12px;font-weight:500;">${l.vorname} ${l.nachname}<div class="dim" style="font-size:10px;">${l.lj}. Lehrjahr Â· ${l.start}</div></div>
        <button class="btn btn-out btn-sm" onclick="window.deleteLehrling('${l.id}')">ğŸ—‘</button>
      </div>`).join('');
  document.getElementById('db-qv-datum').value=S.einstellungen.qvDatum||'2026-07-01';
}
async function saveQVDatum(){
  S.einstellungen.qvDatum=document.getElementById('db-qv-datum').value;
  await wj(`users/${uid()}/einstellungen/data`,S.einstellungen);
  toast('âœ“ QV-Datum gespeichert');
}
async function exportBackup(){
  const bk={version:5,exportDatum:new Date().toISOString(),lehrlinge:S.lehrlinge,lernberichte:S.lernberichte,lzStatus:S.lzStatus,bewertungen:S.bewertungen,einsatzplan:S.einsatzplan,termine:S.termine,szenarien:S.szenarien};
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(bk,null,2)],{type:'application/json'}));
  a.download=`kofa_backup_${new Date().toISOString().slice(0,10)}.json`;a.click();
}
async function importBackup(e){
  const file=e.target.files[0];if(!file)return;
  try{
    const d=JSON.parse(await file.text());
    if(!confirm(`Import: ${d.lehrlinge?.length||0} Lehrlinge, ${d.lernberichte?.length||0} Berichte. Weiter?`))return;
    showLoading(true);
    if(d.lzStatus)await wj(`users/${uid()}/lzStatus/data`,d.lzStatus);
    if(d.bewertungen)await wj(`users/${uid()}/bewertungen/data`,d.bewertungen);
    if(d.einsatzplan)await wj(`users/${uid()}/einsatzplan/data`,d.einsatzplan);
    if(d.lehrlinge)for(const l of d.lehrlinge)await wj(`users/${uid()}/lehrlinge/${l.id}`,l);
    if(d.lernberichte)for(const b of d.lernberichte)await wj(`users/${uid()}/lernberichte/${b.id}`,b);
    if(d.termine)for(const t of d.termine)await wj(`users/${uid()}/termine/${t.id}`,t);
    await loadAll();showLoading(false);renderAll();toast('âœ“ Import erfolgreich');
  }catch(err){showLoading(false);toast('Import-Fehler: '+err.message,'red');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  fillDropdowns();
  renderOverview();renderBildungsplan();renderLernberichte();
  renderBildungsbericht();renderQV();renderEinsatz();
  renderTermine();renderDB();renderBenutzer();
  if(S.einstellungen.apiKey){document.getElementById('ki-key').value=S.einstellungen.apiKey;
    document.getElementById('ki-status').innerHTML='<span style="color:var(--green-l)">âœ“</span>';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT & WINDOW EXPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOM-Init lÃ¤uft nach dem Laden des HTML (defer/module garantiert das,
// aber querySelectorAll braucht den DOM â€” sicher mit DOMContentLoaded)
Object.assign(window,{
  login,register,logout,showTab,selectL,openModal,closeModal,
  setBpSem,toggleLL,toggleLZ,
  openNewBericht,editBericht,saveBericht,showBericht,visiereBericht,deleteBericht,
  uploadAtt,dropAtt,delAtt,
  renderBildungsbericht,setAbtGrade,setAbtComment,saveAbtBew,setFinalGrade,setFinalComment,saveFinalBew,generateBB,
  toggleSzAufgabe,openAddAufgabe,saveAufgabe,saveSzenario,deleteSzenario,
  setEpView,changeEp,resetEp,epCellClick,epMonthClick,epDragOver,epDragLeave,epDrop,palDragStart,setDaySlot,
  openNewTermin,editTermin,saveTermin,erledigeTermin,deleteTermin,
  qAsk,kiSend,kiKey,kiResize,saveApiKey,
  addLehrling,deleteLehrling,saveBenutzer,deleteBenutzer,
  exportBackup,importBackup,saveQVDatum,renderDB
});

// Init nach DOM-Ready
document.addEventListener('DOMContentLoaded',()=>{
  const badge=document.getElementById('today-badge');
  if(badge)badge.textContent=new Date().toLocaleDateString('de-CH',{weekday:'short',day:'numeric',month:'short',year:'numeric'});
  const pw=document.getElementById('auth-pw');
  if(pw)pw.addEventListener('keydown',e=>{if(e.key==='Enter')window.login();});
  document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));
});
</script>
<style>
:root{
  --bg:#131210;--bg2:#1C1916;--card:#1E1B17;
  --border:#2E2A24;--border2:#3A3530;
  --cream:#F2E8D0;--dim:#9A8E78;
  --gold:#C9A84C;--gold-l:#E8D080;
  --green:#5B8C5A;--green-l:#7EC07E;
  --red:#9B3A30;--red-l:#D06050;
  --blue:#2E5A8C;--blue-l:#5A90C8;
  --yellow:#B89020;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--cream);min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 40% at 20% 0%,rgba(201,168,76,.05),transparent);pointer-events:none;z-index:0;}
a{color:var(--blue-l);}

#loading{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:999;display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;}
.spin{width:34px;height:34px;border:3px solid var(--border2);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

#auth-screen{position:fixed;inset:0;background:var(--bg);z-index:500;display:flex;align-items:center;justify-content:center;}
.auth-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:38px;max-width:360px;width:93%;}
.auth-err{font-size:12px;color:var(--red-l);margin-top:8px;min-height:16px;}

header{position:sticky;top:0;z-index:100;background:rgba(19,18,16,.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:0 18px;height:54px;display:flex;align-items:center;gap:10px;}
.logo{display:flex;align-items:center;gap:9px;}
.logo-ico{width:30px;height:30px;background:linear-gradient(135deg,var(--gold),var(--gold-l));border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;}
.logo-n{font-family:'DM Serif Display',serif;font-size:15px;}
.logo-s{font-size:10px;color:var(--dim);letter-spacing:.06em;text-transform:uppercase;}
.hflex{flex:1;}

nav{position:sticky;top:54px;z-index:99;background:var(--bg2);border-bottom:1px solid var(--border);padding:0 18px;display:flex;gap:0;overflow-x:auto;scrollbar-width:none;}
nav::-webkit-scrollbar{display:none;}
.tab{padding:10px 11px;font-size:12px;font-weight:500;color:var(--dim);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;}
.tab:hover{color:var(--cream);}
.tab.active{color:var(--gold);border-bottom-color:var(--gold);}

main{max-width:1300px;margin:0 auto;padding:18px;position:relative;z-index:1;}
.section{display:none;}
.section.active{display:block;animation:fadeIn .25s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.pg-title{font-family:'DM Serif Display',serif;font-size:23px;margin-bottom:3px;}
.pg-sub{font-size:12px;color:var(--dim);margin-bottom:16px;}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
@media(max-width:900px){.g4{grid-template-columns:1fr 1fr;}.g3{grid-template-columns:1fr 1fr;}}
@media(max-width:600px){.g2,.g3,.g4{grid-template-columns:1fr;}}

.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px;}
.card-t{font-family:'DM Serif Display',serif;font-size:15px;margin-bottom:2px;}
.card-s{font-size:11px;color:var(--dim);margin-bottom:14px;}
.divider{height:1px;background:var(--border);margin:14px 0;}

.lb{display:flex;gap:7px;margin-bottom:16px;flex-wrap:wrap;}
.lp{display:flex;align-items:center;gap:8px;padding:6px 12px;border-radius:40px;border:1px solid var(--border);background:var(--card);cursor:pointer;transition:all .2s;}
.lp:hover{border-color:var(--gold);}
.lp.active{background:var(--gold);border-color:var(--gold);color:var(--bg);}
.lp.active .dim{color:rgba(0,0,0,.5);}
.lav{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--bg);flex-shrink:0;}

.sc{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;position:relative;overflow:hidden;}
.sc::after{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--a,#C9A84C);}
.sc-n{font-family:'DM Serif Display',serif;font-size:34px;line-height:1;margin-bottom:4px;}
.sc-l{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.05em;}
.sc-s{font-size:11px;margin-top:5px;}

.pw{margin-bottom:9px;}
.prow{display:flex;justify-content:space-between;margin-bottom:4px;font-size:12px;}
.pbar{height:5px;background:var(--border2);border-radius:3px;overflow:hidden;}
.pfill{height:100%;border-radius:3px;transition:width .6s ease;}

.tag{display:inline-block;font-size:10px;padding:2px 7px;border-radius:20px;font-weight:500;}
.tg{background:rgba(91,140,90,.2);color:var(--green-l);}
.ty{background:rgba(184,144,32,.2);color:#E0B840;}
.tr{background:rgba(155,58,48,.2);color:var(--red-l);}
.tb{background:rgba(46,90,140,.2);color:var(--blue-l);}

.btn{padding:7px 14px;border-radius:8px;font-size:12px;font-weight:500;cursor:pointer;border:none;font-family:'DM Sans',sans-serif;transition:all .2s;display:inline-flex;align-items:center;gap:4px;}
.btn-gold{background:var(--gold);color:var(--bg);}
.btn-gold:hover{background:var(--gold-l);}
.btn-out{background:transparent;border:1px solid var(--border);color:var(--dim);}
.btn-out:hover{border-color:var(--gold);color:var(--cream);}
.btn-sm{padding:4px 9px;font-size:11px;}

label.fl{display:block;font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.06em;margin-top:12px;margin-bottom:4px;}
.fi{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--cream);font-family:'DM Sans',sans-serif;font-size:12px;padding:8px 12px;outline:none;transition:border-color .2s;}
.fi:focus{border-color:var(--gold);}
textarea.fi{min-height:60px;resize:vertical;}

.task-row{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;border:1px solid var(--border);margin-bottom:6px;font-size:12px;background:var(--bg2);}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:24px;max-width:520px;width:93%;max-height:90vh;overflow-y:auto;}
.modal-t{font-family:'DM Serif Display',serif;font-size:19px;margin-bottom:14px;}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;}

/* BILDUNGSPLAN */
.sem-btn{padding:5px 11px;border-radius:20px;border:1px solid var(--border);background:var(--bg2);color:var(--dim);font-size:11px;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;}
.sem-btn:hover{border-color:var(--gold);color:var(--cream);}
.sem-btn.active{background:var(--gold);border-color:var(--gold);color:var(--bg);}
.hkb-block{margin-bottom:6px;}
.hkb-hd{display:flex;align-items:center;gap:9px;padding:10px 14px;background:rgba(201,168,76,.04);border:1px solid rgba(201,168,76,.12);border-radius:10px;cursor:pointer;user-select:none;transition:background .15s;}
.hkb-hd:hover{background:rgba(201,168,76,.08);}
.hkb-hd.open+.hkb-body{display:block;}
.chev{font-size:10px;color:var(--dim);transition:transform .2s;margin-left:auto;}
.hkb-hd.open .chev{transform:rotate(90deg);}
.hkb-code{font-family:'DM Serif Display',serif;font-size:17px;}
.hkb-t{font-size:12px;font-weight:500;flex:1;}
.hkb-body{display:none;margin-left:10px;margin-top:3px;margin-bottom:5px;}
.hk-row{display:flex;align-items:flex-start;gap:8px;padding:7px;border-radius:8px;margin-bottom:2px;}
.hk-row:hover{background:rgba(255,255,255,.02);}
.hk-st{width:19px;height:19px;border-radius:4px;border:1.5px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;margin-top:2px;transition:all .15s;}
.hk-st.done{background:var(--green);border-color:var(--green);color:white;}
.hk-st.part{background:rgba(201,168,76,.2);border-color:var(--gold);color:var(--gold);}
.hk-body{flex:1;}
.hk-meta{display:flex;gap:5px;align-items:center;margin-bottom:2px;flex-wrap:wrap;}
.hk-code{font-size:10px;color:var(--gold);font-weight:700;}
.hk-tax{font-size:10px;color:var(--dim);background:var(--bg2);border:1px solid var(--border);border-radius:3px;padding:1px 4px;}
.hk-t{font-size:12px;cursor:pointer;}
.hk-t:hover{color:var(--gold);}
.hk-prog{font-size:10px;color:var(--dim);margin-top:2px;}
.lz-list{display:none;margin-top:6px;border-left:2px solid var(--border);padding-left:10px;}
.lz-list.open{display:block;}
.lz-row{display:flex;align-items:flex-start;gap:7px;padding:4px 5px;border-radius:5px;cursor:pointer;transition:background .1s;margin-bottom:2px;}
.lz-row:hover{background:rgba(255,255,255,.03);}
.lz-cb{width:14px;height:14px;border-radius:3px;border:1.5px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0;margin-top:1px;transition:all .15s;color:white;}
.lz-cb.on{background:var(--green);border-color:var(--green);}
.lz-t{font-size:11px;color:var(--dim);line-height:1.4;}
.lz-t.done-t{text-decoration:line-through;opacity:.5;}

/* LERNBERICHTE */
.b-sem-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:7px;}
@media(max-width:800px){.b-sem-grid{grid-template-columns:repeat(3,1fr);}}
@media(max-width:480px){.b-sem-grid{grid-template-columns:1fr 1fr;}}
.b-sem{display:flex;flex-direction:column;gap:4px;}
.b-sem-lbl{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.05em;padding:3px 0;font-weight:500;}
.b-card{background:var(--bg2);border:1px solid var(--border);border-radius:9px;padding:9px;cursor:pointer;transition:all .2s;min-height:64px;}
.b-card:hover{border-color:var(--gold);}
.b-card.visiert{background:rgba(91,140,90,.15);border-color:rgba(122,192,122,.4);}
.b-card.eingereicht{background:rgba(184,144,32,.1);border-color:rgba(184,144,32,.3);}
.b-card.add{display:flex;align-items:center;justify-content:center;color:var(--dim);font-size:12px;border-style:dashed;min-height:38px;}
.bd-sec{margin-bottom:10px;}
.bd-sec-lbl{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;}
.bd-sec-body{font-size:12px;padding:9px;border-radius:7px;line-height:1.5;}
.bd-sec-body.ok{background:rgba(91,140,90,.12);border:1px solid rgba(91,140,90,.2);}
.bd-sec-body.warn{background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.18);}
.att-list{display:flex;flex-direction:column;gap:5px;margin:6px 0;}
.att-item{display:flex;align-items:center;gap:7px;padding:7px 10px;background:var(--bg);border:1px solid var(--border);border-radius:7px;font-size:12px;}
.att-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--blue-l);}
.att-zone{border:2px dashed var(--border);border-radius:9px;padding:14px;text-align:center;cursor:pointer;transition:all .2s;margin-top:10px;font-size:12px;color:var(--dim);}
.att-zone:hover,.att-zone.drag{border-color:var(--gold);background:rgba(201,168,76,.04);}

/* BILDUNGSBERICHT */
.bb-item-row{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;padding:9px 0;border-bottom:1px solid var(--border);}
.abcd-btns{display:flex;gap:4px;}
.abcd-btn{width:30px;height:28px;border-radius:6px;border:1.5px solid var(--border2);background:var(--bg);color:var(--dim);font-size:12px;font-weight:700;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s;display:flex;align-items:center;justify-content:center;}
.abcd-btn:hover{border-color:var(--gold);color:var(--gold);}
.abcd-btn.sel-A{background:rgba(91,140,90,.3);border-color:var(--green-l);color:var(--green-l);}
.abcd-btn.sel-B{background:rgba(46,90,140,.3);border-color:var(--blue-l);color:var(--blue-l);}
.abcd-btn.sel-C{background:rgba(184,144,32,.3);border-color:#E0B840;color:#E0B840;}
.abcd-btn.sel-D{background:rgba(155,58,48,.3);border-color:var(--red-l);color:var(--red-l);}
.abt-section{border:1px solid var(--border);border-radius:9px;margin-bottom:7px;overflow:hidden;}
.abt-hd{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;cursor:pointer;background:rgba(255,255,255,.02);transition:background .15s;gap:8px;}
.abt-hd:hover{background:rgba(255,255,255,.04);}
.abt-hd.open+.abt-body{display:block;}
.abt-body{display:none;padding:12px 14px;border-top:1px solid var(--border);}
.bb-prev{font-size:12px;line-height:1.65;}
.bb-prev-h{font-size:10px;color:var(--gold);text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px;font-weight:600;margin-top:10px;}

/* QV */
.qv-block{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;}
.qv-sz-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px;}
.qv-sz-hd{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:8px;}
.amp{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.amp.g{background:var(--green-l);box-shadow:0 0 5px var(--green-l);}
.amp.y{background:#E0B840;box-shadow:0 0 5px #E0B840;}
.amp.r{background:var(--red-l);box-shadow:0 0 5px var(--red-l);}

/* EINSATZPLAN */
.ep-view-btn{padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:var(--bg2);color:var(--dim);font-size:11px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;}
.ep-view-btn.active{background:var(--gold);border-color:var(--gold);color:var(--bg);}
/* Monat */
.ep-month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-top:6px;}
.ep-m-h{font-size:10px;color:var(--dim);font-weight:600;text-align:center;padding:4px 0;text-transform:uppercase;}
.ep-m-cell{min-height:54px;border-radius:7px;padding:5px;cursor:pointer;transition:all .15s;border:1px solid transparent;position:relative;}
.ep-m-cell:hover{border-color:var(--gold);}
.ep-m-cell.other-month{opacity:.35;}
.ep-m-cell.today .ep-m-day{color:var(--gold);font-weight:700;}
.ep-m-cell.ep-selected{outline:2px solid var(--gold);outline-offset:1px;}
.ep-m-day{font-size:11px;margin-bottom:3px;}
.ep-m-abt{font-size:9px;font-weight:500;line-height:1.2;}
.ep-m-abt-empty{height:14px;}
/* Woche */
.ep-grid{display:grid;gap:2px;font-size:11px;}
.ep-h{font-size:10px;font-weight:600;color:var(--dim);text-transform:uppercase;padding:5px;text-align:center;}
.ep-day{padding:6px;font-size:11px;color:var(--dim);display:flex;flex-direction:column;justify-content:center;}
.ep-cell{padding:7px 4px;border-radius:6px;font-size:10px;font-weight:500;text-align:center;border:1px solid transparent;cursor:pointer;transition:all .15s;user-select:none;}
.ep-cell:hover{opacity:.85;transform:scale(1.02);}
.ep-cell.selected{outline:2px solid var(--gold);outline-offset:2px;}
.ep-cell.drag-over{outline:2px solid var(--gold);transform:scale(1.04);}
/* Tag */
.ep-day-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:12px;}
.ep-day-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;}
/* Abteilungs-Farben */
.ae{background:rgba(46,90,140,.2);border-color:rgba(90,143,192,.3);color:var(--blue-l);}
.ar{background:rgba(184,144,32,.15);border-color:rgba(184,144,32,.25);color:#E0C040;}
.ak{background:rgba(91,140,90,.2);border-color:rgba(122,192,122,.3);color:var(--green-l);}
.as{background:rgba(140,70,120,.2);border-color:rgba(180,110,160,.3);color:#D090C0;}
.ah{background:rgba(160,120,60,.2);border-color:rgba(190,150,90,.3);color:#D0A060;}
.aa{background:rgba(58,111,160,.15);color:var(--blue-l);}
.ac{background:rgba(200,80,60,.18);border-color:rgba(200,80,60,.3);color:#E09080;}
.af{background:rgba(255,255,255,.03);color:var(--dim);font-style:italic;}
.af2{background:rgba(255,255,255,.03);color:var(--dim);}
.ep-mini-btn{padding:4px 8px;border-radius:5px;font-size:10px;cursor:pointer;border:1px solid transparent;transition:all .15s;user-select:none;font-family:'DM Sans',sans-serif;}
.ep-mini-btn:hover{transform:scale(1.05);}
.ep-palette{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:11px;margin-bottom:11px;}

/* TERMINE */
.tm-group-lbl{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;font-weight:600;}
.tm-card{display:flex;align-items:flex-start;gap:12px;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;transition:border-color .2s;}
.tm-card:hover{border-color:var(--gold);}
.tm-card.past{opacity:.6;}
.tm-date{text-align:center;flex-shrink:0;min-width:54px;font-size:12px;}
.tm-body{flex:1;}

/* KI */
.ki-wrap{display:flex;flex-direction:column;height:calc(100vh - 290px);min-height:360px;}
.ki-top{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border);}
.ki-qb-row{padding:8px 14px;border-bottom:1px solid var(--border);display:flex;gap:5px;flex-wrap:wrap;}
.ki-msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:9px;}
.ki-in-row{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;}
.ki-ta{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:9px;color:var(--cream);font-family:'DM Sans',sans-serif;font-size:13px;padding:8px 12px;outline:none;resize:none;height:40px;transition:border-color .2s;}
.ki-ta:focus{border-color:var(--gold);}
.ki-msg{max-width:85%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.55;}
.ki-msg.user{background:var(--gold);color:var(--bg);align-self:flex-end;border-radius:12px 12px 3px 12px;}
.ki-msg.assistant{background:var(--bg2);border:1px solid var(--border);align-self:flex-start;border-radius:12px 12px 12px 3px;}
.ki-qb{padding:4px 10px;border-radius:20px;border:1px solid var(--border);background:var(--bg);color:var(--dim);font-size:11px;cursor:pointer;transition:all .2s;white-space:nowrap;}
.ki-qb:hover{border-color:var(--gold);color:var(--gold);}

/* DATENBANK */
.sr{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px;}

/* TOAST */
#toast{position:fixed;bottom:22px;right:22px;background:var(--bg2);border-radius:10px;padding:10px 18px;font-size:13px;z-index:999;opacity:0;transform:translateY(8px);transition:all .3s;pointer-events:none;border:1px solid var(--green);}
#toast.show{opacity:1;transform:translateY(0);}
#toast.ok{border-color:var(--green);color:var(--green-l);}
#toast.err{border-color:var(--red);color:var(--red-l);}
#toast.warn{border-color:var(--yellow);color:#E0C040;}

::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:var(--bg2);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
</style>

<!-- LOADING & TOAST -->
<div id="loading"><div class="spin"></div><div style="font-size:12px;color:var(--dim);">Ladenâ€¦</div></div>
<div id="toast" class="ok"></div>

<!-- AUTH -->
<div id="auth-screen">
  <div class="auth-box">
    <div style="text-align:center;font-size:28px;margin-bottom:10px;">ğŸ¨</div>
    <div style="font-family:'DM Serif Display',serif;font-size:20px;text-align:center;margin-bottom:2px;">Ausbildungs-Cockpit</div>
    <div style="font-size:11px;color:var(--dim);text-align:center;margin-bottom:24px;">Hotel-KoFa EFZ</div>
    <label class="fl">E-Mail</label>
    <input class="fi" type="email" id="auth-email" placeholder="berufsbildner@hotel.ch" autocomplete="email">
    <label class="fl">Passwort</label>
    <input class="fi" type="password" id="auth-pw" placeholder="Passwort">
    <div class="auth-err" id="auth-err"></div>
    <div style="display:flex;gap:8px;margin-top:14px;">
      <button class="btn btn-gold" style="flex:1;" onclick="window.login()">Einloggen</button>
      <button class="btn btn-out" style="flex:1;" onclick="window.register()">Registrieren</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
<header>
  <div class="logo">
    <div class="logo-ico">ğŸ¨</div>
    <div><div class="logo-n">Ausbildungs-Cockpit</div><div class="logo-s">Hotel-KoFa EFZ</div></div>
  </div>
  <div class="hflex"></div>
  <div style="font-size:11px;color:var(--dim);background:var(--bg2);border:1px solid var(--border);padding:4px 10px;border-radius:20px;" id="today-badge"></div>
  <span style="font-size:11px;color:var(--dim);margin-left:6px;" id="user-email"></span>
  <button class="btn btn-out btn-sm" style="margin-left:6px;" onclick="window.logout()">Abmelden</button>
</header>
<nav>
  <div class="tab active" onclick="window.showTab('overview',this)">ğŸ“Š Ãœbersicht</div>
  <div class="tab" onclick="window.showTab('bildungsplan',this)">ğŸ“š Bildungsplan</div>
  <div class="tab" onclick="window.showTab('lernberichte',this)">ğŸ“ Lernberichte</div>
  <div class="tab" onclick="window.showTab('bildungsbericht',this)">ğŸ“‹ Bildungsbericht</div>
  <div class="tab" onclick="window.showTab('qv',this)">ğŸ¯ QV-Vorbereitung</div>
  <div class="tab" onclick="window.showTab('einsatzplan',this)">ğŸ“… Einsatzplan</div>
  <div class="tab" onclick="window.showTab('termine',this)">ğŸ—“ Termine</div>
  <div class="tab" onclick="window.showTab('ki',this)">ğŸ¤– KI-Assistent</div>
  <div class="tab" id="tab-benutzer" onclick="window.showTab('benutzer',this)" style="display:none">ğŸ‘¥ Benutzer</div>
  <div class="tab" onclick="window.showTab('db',this)">ğŸ’¾ Datenbank</div>
</nav>
<main>

<!-- ÃœBERSICHT -->
<div class="section active" id="sec-overview">
  <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
    <div><div class="pg-title">Ãœbersicht</div><div class="pg-sub">Aktueller Ausbildungsstand</div></div>
    <div style="display:flex;gap:7px;">
      <button class="btn btn-out" onclick="window.openModal('lehrling')">+ Lehrling</button>
      <button class="btn btn-gold" onclick="window.openNewBericht()">+ Lernbericht</button>
    </div>
  </div>
  <div class="lb" id="ov-lb"></div>
  <div class="g4" style="margin-bottom:14px;" id="ov-stats"></div>
  <div id="ov-sem"></div>
  <div class="g2">
    <div class="card"><div class="card-t">HKB Fortschritt</div><div class="card-s">Handlungskompetenzbereiche</div><div id="ov-prog"></div></div>
    <div class="card"><div class="card-t">Offene Aufgaben</div><div class="card-s">Pendente Aktionen & Termine</div><div id="ov-tasks"></div></div>
  </div>
</div>

<!-- BILDUNGSPLAN -->
<div class="section" id="sec-bildungsplan">
  <div class="pg-title">Bildungsplan</div>
  <div class="pg-sub">Exakte LZ-Zuordnung gemÃ¤ss GesamtÃ¼bersicht Â· Semester-Filter Â· Semester âœ“ wenn alle LZ erledigt</div>
  <div class="lb" id="bp-lb"></div>
  <div class="card" style="margin-bottom:14px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <div><div class="card-t">Gesamtfortschritt</div><div class="card-s" id="bp-sub">â€”</div></div>
      <div style="font-size:15px;font-weight:700;" id="bp-total-lbl">0%</div>
    </div>
    <div class="pbar" style="height:8px;margin-bottom:12px;"><div class="pfill" id="bp-total-bar" style="width:0%;background:var(--gold)"></div></div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;" id="bp-sem-btns"></div>
  </div>
  <div class="card"><div class="card-t">Handlungskompetenzen</div><div class="card-s">HKB aufklappen Â· LZ einzeln abhaken Â· [Sx] = Semester-Zuordnung</div><div id="bp-hkb"></div></div>
</div>

<!-- LERNBERICHTE -->
<div class="section" id="sec-lernberichte">
  <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:6px;">
    <div><div class="pg-title">Lernberichte</div><div class="pg-sub">Klicken zum Ã–ffnen Â· Bearbeiten Â· AnhÃ¤nge zu Firebase Storage</div></div>
    <button class="btn btn-gold" onclick="window.openNewBericht()">+ Neu</button>
  </div>
  <div class="lb" id="lb-lb"></div>
  <div class="g2">
    <div class="card"><div class="card-t">Ãœbersicht nach Semester</div><div id="b-grid"></div></div>
    <div id="b-detail" style="display:none;"></div>
  </div>
</div>

<!-- BILDUNGSBERICHT -->
<div class="section" id="sec-bildungsbericht">
  <div class="pg-title">Bildungsbericht</div>
  <div class="pg-sub">Beurteilung gemÃ¤ss SDBB-Vorlage Â· Aâ€“D pro Kriterium Â· Abteilungen geben eigene Beurteilung ab</div>
  <div class="lb" id="bb-lb"></div>
  <div id="bb-role"></div>
  <div class="g2" style="margin-top:12px;">
    <div id="bb-form"></div>
    <div class="card">
      <div class="card-t">Bericht-Vorschau</div>
      <div class="card-s">Nach Â«Bericht generierenÂ» drÃ¼cken</div>
      <div id="bb-preview"><div style="text-align:center;padding:28px;color:var(--dim);font-size:12px;">Klicke Â«Bericht generierenÂ» fÃ¼r die Vorschau.</div></div>
    </div>
  </div>
</div>

<!-- QV -->
<div class="section" id="sec-qv">
  <div class="pg-title">QV-Vorbereitung 2026</div>
  <div class="pg-sub">CPEX Â· PEX Â· Eigene Szenarien erstellen Â· Aufgaben abhaken Â· Bereitschaft pro HK</div>
  <div class="lb" id="qv-lb"></div>
  <div class="g3" style="margin-bottom:14px;">
    <div style="background:rgba(201,168,76,.07);border:1px solid rgba(201,168,76,.25);border-radius:12px;padding:18px;text-align:center;">
      <div style="font-family:'DM Serif Display',serif;font-size:44px;color:var(--gold);" id="qv-days">â€“</div>
      <div style="font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:.08em;margin-top:4px;">Tage bis QV</div>
    </div>
    <div class="card">
      <div class="card-t">LZ-Fortschritt</div>
      <div class="pbar" style="margin-top:8px;"><div class="pfill" id="qv-lz-bar" style="width:0%;background:var(--green-l)"></div></div>
      <div style="text-align:right;font-size:12px;color:var(--green-l);margin-top:4px;" id="qv-lz-pct">0%</div>
    </div>
    <div class="card">
      <div class="card-t">PrÃ¼fungsformat</div>
      <div style="font-size:12px;line-height:1.8;color:var(--dim);">
        <b style="color:var(--cream)">CPEX</b> Â· 3 Situationen Â· je 20 Min.<br>
        <b style="color:var(--cream)">PEX</b> Â· FachgesprÃ¤ch Â· 40 Min.<br>
        <b style="color:var(--cream)">BK</b> Â· Berufskenntnisse Â· schriftlich
      </div>
    </div>
  </div>
  <div class="g2">
    <div class="card"><div class="card-t">Bereitschaft pro HKB</div><div class="card-s">ğŸŸ¢ â‰¥80% Â· ğŸŸ¡ â‰¥50% Â· ğŸ”´ &lt;50% LZ</div><div id="qv-hkb"></div></div>
    <div class="card"><div class="card-t">Szenarien & Aufgaben</div><div class="card-s">Standard + eigene Szenarien Â· Aufgaben abhaken oder hinzufÃ¼gen</div><div id="qv-szenarien"></div></div>
  </div>
</div>

<!-- EINSATZPLAN -->
<div class="section" id="sec-einsatzplan">
  <div class="pg-title">Einsatzplan</div>
  <div class="pg-sub">Monats-, Wochen- und Tagesansicht Â· Klicken oder Drag & Drop</div>
  <div class="lb" id="ep-lb"></div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:12px;">
      <div class="card-t" id="ep-label">Einsatzplan</div>
      <div style="display:flex;gap:5px;align-items:center;flex-wrap:wrap;">
        <button class="ep-view-btn active" id="epv-month" onclick="window.setEpView('month')">Monat</button>
        <button class="ep-view-btn" id="epv-week" onclick="window.setEpView('week')">Woche</button>
        <button class="ep-view-btn" id="epv-day" onclick="window.setEpView('day')">Tag</button>
        <div style="width:1px;height:18px;background:var(--border);margin:0 3px;"></div>
        <button class="btn btn-out btn-sm" onclick="window.changeEp(-1)">â†</button>
        <button class="btn btn-out btn-sm" onclick="window.resetEp()">Heute</button>
        <button class="btn btn-out btn-sm" onclick="window.changeEp(1)">â†’</button>
      </div>
    </div>
    <div class="ep-palette" id="ep-palette"></div>
    <div id="ep-main"></div>
  </div>
</div>

<!-- TERMINE -->
<div class="section" id="sec-termine">
  <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
    <div><div class="pg-title">Termine & Abmachungen</div><div class="pg-sub">Fristen, Lernziele, GesprÃ¤che und Vereinbarungen pro Lernende/r</div></div>
    <button class="btn btn-gold" onclick="window.openNewTermin()">+ Termin</button>
  </div>
  <div class="lb" id="tm-lb"></div>
  <div class="g2">
    <div class="card"><div id="tm-list"></div></div>
    <div class="card">
      <div class="card-t">Termin-Typen</div>
      <div style="display:flex;flex-direction:column;gap:7px;font-size:12px;margin-top:6px;">
        <div>ğŸ“ <b>Lernbericht</b> â€” Abgabefrist</div>
        <div>ğŸ“š <b>Lernziel</b> â€” Thema bis Datum beherrschen</div>
        <div>ğŸ¤ <b>GesprÃ¤ch</b> â€” SemestergesprÃ¤ch, Feedback</div>
        <div>ğŸ¯ <b>PrÃ¼fung</b> â€” QV, ZwischenprÃ¼fung, ÃœK</div>
        <div>ğŸ“Œ <b>Sonstiges</b> â€” Freie Vereinbarungen</div>
      </div>
    </div>
  </div>
</div>

<!-- KI -->
<div class="section" id="sec-ki">
  <div class="pg-title">KI-Assistent</div>
  <div class="pg-sub">Bildungsplan-Fragen Â· QV-Tipps Â· Ausbildungsmethoden via Anthropic Claude</div>
  <div class="card" style="padding:0;overflow:hidden;">
    <div class="ki-top">
      <span style="font-size:11px;color:var(--dim);white-space:nowrap;">API-Key:</span>
      <input type="password" class="fi" id="ki-key" placeholder="sk-ant-..." style="margin:0;" onchange="window.saveApiKey()">
      <span id="ki-status" style="font-size:11px;"></span>
    </div>
    <div class="ki-qb-row">
      <button class="ki-qb" onclick="window.qAsk('Was sind die wichtigsten LZ im HKB 1?')">HKB 1 LZ</button>
      <button class="ki-qb" onclick="window.qAsk('Wie bereite ich optimal auf das PEX-FachgesprÃ¤ch vor?')">PEX Tipps</button>
      <button class="ki-qb" onclick="window.qAsk('Was sind die Unterschiede zwischen CPEX und PEX?')">CPEX vs PEX</button>
      <button class="ki-qb" onclick="window.qAsk('ErklÃ¤re die Taxonomiestufen K1-K6 mit Hotel-Beispielen.')">Taxonomie</button>
      <button class="ki-qb" onclick="window.qAsk('Wie fÃ¼hre ich ein gutes SemestergesprÃ¤ch?')">SemestergesprÃ¤ch</button>
    </div>
    <div class="ki-wrap">
      <div class="ki-msgs" id="ki-msgs">
        <div class="ki-msg assistant">ğŸ‘‹ <strong>Willkommen!</strong> Ich kenne den Bildungsplan Hotel-KoFa EFZ mit allen 4 HKBs, 21 Handlungskompetenzen und allen Leistungszielen. Gib deinen Anthropic API-Key ein und stelle Fragen.</div>
      </div>
      <div class="ki-in-row">
        <textarea class="ki-ta" id="ki-in" placeholder="Frage zur Ausbildungâ€¦" onkeydown="window.kiKey(event)" oninput="window.kiResize(this)"></textarea>
        <button class="btn btn-gold" onclick="window.kiSend()" style="align-self:flex-end;">â†‘</button>
      </div>
    </div>
  </div>
</div>

<!-- BENUTZER -->
<div class="section" id="sec-benutzer">
  <div class="pg-title">Benutzer & Rollen</div>
  <div class="pg-sub">Weise anderen Benutzern eine Abteilungsrolle zu Â· Nur Admin sieht dieses MenÃ¼</div>
  <div id="benutzer-content"></div>
</div>

<!-- DATENBANK -->
<div class="section" id="sec-db">
  <div class="pg-title">Datenbank & Einstellungen</div>
  <div class="pg-sub">Firebase Firestore Â· Backup Â· QV-Datum Â· Lernende verwalten</div>
  <div class="g2">
    <div>
      <div class="card" style="margin-bottom:14px;">
        <div class="card-t">Lernende verwalten</div>
        <div id="db-lehrlinge"></div>
        <button class="btn btn-out" style="width:100%;margin-top:10px;" onclick="window.openModal('lehrling')">+ Lehrling hinzufÃ¼gen</button>
      </div>
      <div class="card">
        <div class="card-t">QV-Datum</div>
        <div class="card-s">Stichtag fÃ¼r den Countdown</div>
        <div style="display:flex;gap:8px;">
          <input class="fi" type="date" id="db-qv-datum" style="flex:1;">
          <button class="btn btn-gold" onclick="window.saveQVDatum()">Speichern</button>
        </div>
      </div>
    </div>
    <div>
      <div class="card" style="margin-bottom:14px;">
        <div class="card-t">Datenbankstatus (Firebase)</div>
        <div id="db-status"></div>
      </div>
      <div class="card">
        <div class="card-t">Backup</div>
        <button class="btn btn-gold" style="width:100%;margin-bottom:8px;" onclick="window.exportBackup()">â¬‡ Export (JSON)</button>
        <input type="file" id="import-f" accept=".json" style="display:none;" onchange="window.importBackup(event)">
        <button class="btn btn-out" style="width:100%;" onclick="window.document.getElementById('import-f').click()">ğŸ“ Import</button>
      </div>
    </div>
  </div>
</div>

</main>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-lehrling">
  <div class="modal">
    <div class="modal-t">Lehrling erfassen</div>
    <label class="fl">Vorname</label><input class="fi" type="text" id="nl-vn" placeholder="z.B. Mia">
    <label class="fl">Nachname</label><input class="fi" type="text" id="nl-nn" placeholder="z.B. Steiner">
    <label class="fl">Lehrjahr</label>
    <select class="fi" id="nl-lj"><option value="1">1. Lehrjahr</option><option value="2" selected>2. Lehrjahr</option><option value="3">3. Lehrjahr</option></select>
    <label class="fl">Ausbildungsstart</label>
    <input class="fi" type="month" id="nl-start" value="2024-08">
    <div class="modal-actions">
      <button class="btn btn-out" onclick="window.closeModal('lehrling')">Abbrechen</button>
      <button class="btn btn-gold" onclick="window.addLehrling()">âœ“ HinzufÃ¼gen</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-bericht">
  <div class="modal">
    <div class="modal-t" id="nb-modal-title">Neuer Lernbericht</div>
    <input type="hidden" id="nb-edit-id">
    <label class="fl">Lernende/r</label><select class="fi" id="nb-lid"></select>
    <label class="fl">Semester</label>
    <select class="fi" id="nb-sem">
      <option value="1">S1</option><option value="2">S2</option><option value="3">S3</option>
      <option value="4" selected>S4</option><option value="5">S5</option><option value="6">S6</option>
    </select>
    <label class="fl">Handlungskompetenz</label><select class="fi" id="nb-hk"></select>
    <label class="fl">Thema / Titel</label>
    <input class="fi" type="text" id="nb-thema" placeholder="z.B. Check-in bei Gruppenanreise">
    <label class="fl">Status</label>
    <select class="fi" id="nb-status">
      <option value="eingereicht">ğŸ“„ Eingereicht</option>
      <option value="visiert">âœ… Visiert</option>
      <option value="offen">â—‹ Offen</option>
    </select>
    <label class="fl">Positiv aufgefallen</label>
    <textarea class="fi" id="nb-pos" placeholder="StÃ¤rkenâ€¦"></textarea>
    <label class="fl">VerbesserungsmÃ¶glichkeiten</label>
    <textarea class="fi" id="nb-verb" placeholder="Entwicklungsfelderâ€¦"></textarea>
    <div class="modal-actions">
      <button class="btn btn-out" onclick="window.closeModal('bericht')">Abbrechen</button>
      <button class="btn btn-gold" onclick="window.saveBericht()">âœ“ Speichern</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-termin">
  <div class="modal">
    <div class="modal-t" id="tm-modal-title">Neuer Termin</div>
    <input type="hidden" id="tm-edit-id">
    <label class="fl">Lernende/r</label><select class="fi" id="tm-lid"></select>
    <label class="fl">Titel</label>
    <input class="fi" type="text" id="tm-titel" placeholder="z.B. Lernbericht Semester 3 einreichen">
    <label class="fl">Datum</label><input class="fi" type="date" id="tm-datum">
    <label class="fl">Typ</label>
    <select class="fi" id="tm-typ">
      <option value="lernbericht">ğŸ“ Lernbericht</option>
      <option value="lernziel">ğŸ“š Lernziel</option>
      <option value="meeting">ğŸ¤ GesprÃ¤ch/Meeting</option>
      <option value="pruefung">ğŸ¯ PrÃ¼fung/QV</option>
      <option value="sonstiges">ğŸ“Œ Sonstiges</option>
    </select>
    <label class="fl">Notizen (optional)</label>
    <textarea class="fi" id="tm-beschr" placeholder="Detailsâ€¦"></textarea>
    <div class="modal-actions">
      <button class="btn btn-out" onclick="window.closeModal('termin')">Abbrechen</button>
      <button class="btn btn-gold" onclick="window.saveTermin()">âœ“ Speichern</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-szenario">
  <div class="modal">
    <div class="modal-t">Neues Szenario erstellen</div>
    <label class="fl">Titel</label>
    <input class="fi" type="text" id="sz-titel" placeholder="z.B. Eigene Ãœbungssituation: Check-in Gruppe">
    <label class="fl">Beschreibung</label>
    <textarea class="fi" id="sz-beschr" placeholder="Kurze Situationsbeschreibungâ€¦"></textarea>
    <label class="fl">Aufgaben (eine pro Zeile)</label>
    <textarea class="fi" id="sz-aufgaben" style="min-height:100px;" placeholder="Aufgabe 1&#10;Aufgabe 2&#10;Aufgabe 3"></textarea>
    <div class="modal-actions">
      <button class="btn btn-out" onclick="window.closeModal('szenario')">Abbrechen</button>
      <button class="btn btn-gold" onclick="window.saveSzenario()">âœ“ Erstellen</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-aufgabe">
  <div class="modal">
    <div class="modal-t">Aufgabe hinzufÃ¼gen</div>
    <input type="hidden" id="add-aufgabe-sz-id">
    <label class="fl">Aufgabentext</label>
    <textarea class="fi" id="add-aufgabe-text" placeholder="Beschreibe die Ãœbungsaufgabeâ€¦"></textarea>
    <div class="modal-actions">
      <button class="btn btn-out" onclick="window.closeModal('aufgabe')">Abbrechen</button>
      <button class="btn btn-gold" onclick="window.saveAufgabe()">âœ“ HinzufÃ¼gen</button>
    </div>
  </div>
</div>

</body>
</html>
